# LPG DDNS変更対応 - 2025年7月31日

## 概要
OmadaのDDNS制限（1つのWANポートに1つのDDNSのみ）により、既存の`akb001yebraxfqsm9y.dyndns-web.com`を使用してパスベースルーティングを実装しました。

## 変更内容

### 1. ドメイン構成の変更

**変更前:**
- lacisstack.ath.cx （新規DDNSが必要）

**変更後:**
- akb001yebraxfqsm9y.dyndns-web.com/lacisstack/ （既存DDNSを使用）

### 2. ルーティング設定

| パス | 転送先 | 用途 |
|------|--------|------|
| /lacisstack | - | LacisStackサービスのベースパス |
| /lacisstack/boards | 192.168.234.10:8080 | ホワイトボードアプリ |
| /lacisstack/boards/ws | 192.168.234.10:8081 | WebSocket接続 |
| /lacisstack/api | 192.168.234.11:3000 | APIサーバー |

### 3. 更新されたファイル

#### config/config.json
```json
{
  "hostdomains": {
    "akb001yebraxfqsm9y.dyndns-web.com": "192.168.234.0/24"
  },
  "hostingdevice": {
    "akb001yebraxfqsm9y.dyndns-web.com": {
      "/lacisstack/boards": {
        "deviceip": "192.168.234.10",
        "port": [8080],
        "sitename": "whiteboard",
        "ips": ["192.168.3.0/24"]
      }
      // ... 他のパス設定
    }
  }
}
```

#### config/caddy/Caddyfile
- `https://akb001yebraxfqsm9y.dyndns-web.com`ブロックを追加
- パスベースのハンドラーを設定
- `uri strip_prefix`でパスのプレフィックスを除去
- `X-Forwarded-Prefix`ヘッダーでオリジナルパスを通知

## デプロイメント手順

### 1. 手動SSH接続
```bash
ssh lacissystem@192.168.234.2
# パスワード: lacis12345@
```

### 2. ファイル転送（ローカルから）
```bash
scp lpg-deploy-v2.tar.gz lacissystem@192.168.234.2:/home/lacissystem/
```

### 3. サーバー上での実行
```bash
# ファイル展開
tar -xzf lpg-deploy-v2.tar.gz

# セットアップ実行
sudo ./scripts/setup-lpg.sh
```

### 4. 動作確認
```bash
# Caddyの状態確認
sudo systemctl status caddy

# 設定の確認
sudo caddy validate --config /etc/caddy/Caddyfile

# ログの確認
sudo tail -f /var/log/lpg/caddy.log
```

## アクセスURL

### 管理UI
- https://192.168.234.2:8443 （VLAN1からのみ）

### LacisStackサービス
- https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/
- https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards
- wss://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards/ws

## LacisDrawBoards側の対応

LacisDrawBoardsでは以下の設定変更が必要です：

### 1. 環境変数
```env
NEXT_PUBLIC_BASE_PATH=/lacisstack/boards
NEXT_PUBLIC_API_URL=https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/api
NEXT_PUBLIC_WS_URL=wss://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards/ws
```

### 2. Next.js設定
```javascript
// next.config.js
module.exports = {
  basePath: '/lacisstack/boards',
  // ...
}
```

### 3. APIクライアント
X-Forwarded-Prefixヘッダーを処理するように更新が必要な場合があります。

## 注意事項

1. **証明書**: Let's Encryptは`akb001yebraxfqsm9y.dyndns-web.com`ドメインで自動取得されます
2. **既存サービス**: ルートパス（/）は既存のサービスに影響しません
3. **アクセス制御**: VLAN1（192.168.3.0/24）からのみアクセス可能に設定
4. **WebSocket**: Caddyが自動的にWebSocket接続をアップグレード

## トラブルシューティング

### Caddyが起動しない場合
```bash
# 設定ファイルの検証
sudo caddy validate --config /etc/caddy/Caddyfile

# エラーログの確認
sudo journalctl -u caddy -f
```

### ルーティングが機能しない場合
```bash
# アクセスログの確認
sudo tail -f /var/log/lpg/access.log

# Caddyの管理APIで設定確認
curl http://localhost:2019/config/
```

---
作成日: 2025年7月31日
作成者: Claude Code Assistant