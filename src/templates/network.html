{% extends "base.html" %}

{% block title %}Network{% endblock %}

{% block content %}
<div class="Subhead">
    <h2 class="Subhead-heading">ネットワーク状態</h2>
</div>

<div class="d-flex flex-wrap">
    <!-- システムメトリクス -->
    <div class="Box mt-3 mr-3" style="flex: 1; min-width: 300px;">
        <div class="Box-header">
            <h3 class="Box-title">システムメトリクス</h3>
        </div>
        <div class="Box-body">
            <div class="mb-3">
                <h4 class="f5 text-normal">CPU使用率</h4>
                <div class="Progress">
                    <span class="Progress-item color-bg-success-emphasis" 
                          style="width: {{ metrics.cpu_usage }}%"></span>
                </div>
                <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.cpu_usage) }}%</p>
            </div>
            
            <div class="mb-3">
                <h4 class="f5 text-normal">メモリ使用率</h4>
                <div class="Progress">
                    <span class="Progress-item color-bg-success-emphasis" 
                          style="width: {{ metrics.memory_usage }}%"></span>
                </div>
                <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.memory_usage) }}%</p>
            </div>
            
            <div>
                <h4 class="f5 text-normal">総リクエスト数</h4>
                <p class="f2-light">{{ metrics.requests_total }}</p>
            </div>
        </div>
    </div>
    
    <!-- ネットワーク設定 -->
    <div class="Box mt-3" style="flex: 1; min-width: 300px;">
        <div class="Box-header">
            <h3 class="Box-title">ネットワーク設定</h3>
        </div>
        <div class="Box-body">
            <dl>
                <dt class="f5 text-normal">IPアドレス</dt>
                <dd class="color-fg-muted">192.168.234.2</dd>
                
                <dt class="f5 text-normal mt-3">VLAN</dt>
                <dd class="color-fg-muted">VLAN555 (lacis_proxy_gateway)</dd>
                
                <dt class="f5 text-normal mt-3">開放ポート</dt>
                <dd class="color-fg-muted">
                    <span class="Label mr-1">80 (HTTP)</span>
                    <span class="Label mr-1">443 (HTTPS)</span>
                    <span class="Label">8443 (Admin)</span>
                </dd>
                
                <dt class="f5 text-normal mt-3">プロキシ状態</dt>
                <dd>
                    <span class="Label Label--success">Running</span>
                </dd>
            </dl>
        </div>
    </div>
</div>

<!-- 接続テスト -->
<div class="Box mt-3">
    <div class="Box-header">
        <h3 class="Box-title">接続テスト</h3>
    </div>
    <div class="Box-body">
        <form id="testForm" class="d-flex">
            <input type="text" class="form-control flex-1" id="testUrl" 
                   placeholder="テストURL（例: http://192.168.234.10:8080）">
            <button type="submit" class="btn btn-primary ml-2">テスト実行</button>
        </form>
        <div id="testResult" class="mt-3"></div>
    </div>
</div>

<script>
document.getElementById('testForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = document.getElementById('testUrl').value;
    const resultDiv = document.getElementById('testResult');
    
    if (!url) {
        alert('URLを入力してください');
        return;
    }
    
    resultDiv.innerHTML = '<p class="color-fg-muted">テスト中...</p>';
    
    try {
        const response = await fetch('/api/system/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            resultDiv.innerHTML = `
                <div class="flash flash-success">
                    接続成功: ${data.result}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="flash flash-error">
                    接続失敗: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="flash flash-error">
                エラー: ${error}
            </div>
        `;
    }
});

// メトリクス自動更新（10秒ごと）
setInterval(async () => {
    if (document.visibilityState === 'visible') {
        try {
            const response = await fetch('/api/system/status');
            const data = await response.json();
            // TODO: メトリクス更新処理
        } catch (error) {
            console.error('Failed to update metrics:', error);
        }
    }
}, 10000);
</script>
{% endblock %}