{% extends "base_unified.html" %}

{% block title %}Devices{% endblock %}

{% block extra_styles %}
<style>
    .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }
    
    .device-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .device-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-card);
        border-color: var(--accent-blue);
    }
    
    .device-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
    }
    
    .device-card:hover::before {
        transform: scaleX(1);
    }
    
    .device-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-md);
    }
    
    .device-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-xlarge);
        color: var(--accent-blue);
    }
    
    .device-name {
        font-size: var(--font-size-large);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
    }
    
    .device-info {
        display: grid;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
    }
    
    .info-row {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: var(--spacing-sm);
        align-items: center;
    }
    
    .info-label {
        font-size: var(--font-size-small);
        color: var(--text-secondary);
        font-weight: var(--font-weight-medium);
    }
    
    .info-value {
        font-size: var(--font-size-small);
        color: var(--text-primary);
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
    }
    
    .device-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-subtle);
    }
    
    .btn-small {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-small);
    }
    
    .btn-edit {
        background-color: var(--accent-blue);
        color: white;
    }
    
    .btn-edit:hover {
        background-color: #0051a3;
    }
    
    .btn-delete {
        background-color: transparent;
        color: var(--accent-red);
        border: 1px solid var(--accent-red);
    }
    
    .btn-delete:hover {
        background-color: var(--accent-red);
        color: white;
    }
    
    .add-device-btn {
        background-color: var(--accent-green);
        color: white;
        padding: var(--spacing-sm) var(--spacing-lg);
        font-size: var(--font-size-base);
        margin-bottom: var(--spacing-xl);
    }
    
    .add-device-btn:hover {
        background-color: #28a745;
    }
    
    .empty-state {
        text-align: center;
        padding: var(--spacing-xxl);
        color: var(--text-secondary);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.3;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background-color: var(--bg-secondary);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-strong);
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-lg);
    }
    
    .modal-title {
        font-size: var(--font-size-xlarge);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: var(--font-size-xlarge);
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }
    
    .close-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }
    
    /* Ensure input text is visible in dark theme */
    .form-control {
        color: var(--text-primary) !important;
        background-color: var(--bg-tertiary) !important;
    }
    
    .form-control:focus {
        color: #ffffff !important;
        background-color: var(--bg-secondary) !important;
    }
    
    .form-hint {
        display: block;
        margin-top: 4px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Port protocol display styles */
    .port-list {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .port-item {
        background-color: var(--bg-tertiary);
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: 1px solid var(--border-subtle);
    }
    
    .port-protocol {
        color: var(--text-secondary);
        font-size: 0.75em;
        margin-left: 4px;
        opacity: 0.8;
        font-weight: 500;
    }
    
    .port-item:hover {
        background-color: var(--bg-hover);
        border-color: var(--primary);
    }
    
    /* Modal port input helper */
    #portHelperText {
        font-size: 0.875em;
        color: var(--text-secondary);
        margin-top: 4px;
        font-style: italic;
    }
    
    /* Edit and Delete button styles */
    .btn-icon {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-secondary);
        padding: 6px 10px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }
    
    .btn-icon:hover {
        background-color: var(--bg-hover);
        color: var(--accent-blue);
        border-color: var(--accent-blue);
    }
    
    .btn-icon.btn-danger {
        color: var(--accent-red);
    }
    
    .btn-icon.btn-danger:hover {
        background-color: var(--accent-red);
        color: white;
        border-color: var(--accent-red);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-server"></i>
        Device Management
    </h1>
    <p class="page-subtitle">Manage devices accessible through the proxy</p>
</div>

<button class="btn add-device-btn" onclick="showAddDeviceModal()">
    <i class="fas fa-plus-circle"></i>
    <span>Add Device</span>
</button>

<div id="device-container">
    <div class="device-grid" id="device-grid">
        <!-- Device cards will be dynamically inserted here -->
    </div>
</div>

<!-- デバイス追加/編集モーダル -->
<div id="deviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Add Device</h2>
            <button class="close-btn" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="deviceForm">
            <input type="hidden" id="deviceId" name="device_id" value="">
            <div class="form-group">
                <label class="form-label">Device Name</label>
                <input type="text" class="form-control" id="deviceName" name="name" required>
            </div>
            <div class="form-group">
                <label class="form-label">IP Address</label>
                <input type="text" class="form-control" id="deviceIp" name="ip_address" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
            </div>
            <div class="form-group">
                <label class="form-label">Port (comma-separated for multiple)</label>
                <input type="text" class="form-control" id="devicePort" name="port" value="80" required>
                <small id="portHelperText" class="form-hint">Enter port numbers separated by commas (e.g., 80, 443, 8080)</small>
            </div>
            <div class="form-group">
                <label class="form-label">Path</label>
                <input type="text" class="form-control" id="devicePath" name="path" placeholder="/service/" required>
                <small class="form-hint">パスは / で開始・終了する必要があります (例: /lacisstack/boards/)</small>
            </div>
            <div class="form-group">
                <label class="form-label">Domain Name</label>
                <select class="form-control" id="domainName" name="domain_name" required>
                    <option value="">-- Select Domain --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="deviceDescription" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Device Type</label>
                <select class="form-control" id="deviceType" name="device_type">
                    <option value="server">Server</option>
                    <option value="application">Application</option>
                    <option value="database">Database</option>
                    <option value="network">Network Device</option>
                </select>
            </div>
            <div class="device-actions">
                <button type="submit" class="btn btn-edit">
                    <i class="fas fa-save"></i>
                    <span>Save</span>
                </button>
                <button type="button" class="btn btn-delete" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                    <span>Cancel</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function normalizePath(path) {
    if (!path || path.trim() === """""") return "/";
    path = path.trim();
    if (!path.startsWith("/")) path = "/" + path;
    if (!path.endsWith("/")) path = path + "/";
    return path;
}
let devices = [];

// ページ読み込み時
document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    loadDomains();
    
    // フォームのsubmitイベント
    document.getElementById('deviceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveDevice();
    });
    
    // Add event listener for port input
    const portInput = document.getElementById('devicePort');
    if (portInput) {
        portInput.addEventListener('input', updatePortHelper);
        portInput.addEventListener('change', updatePortHelper);
    }
});

// デバイス一覧を取得
function loadDevices() {
    const basePath = window.location.pathname.includes('/lpg-admin') ? '/lpg-admin' : '';
    
    console.log('Loading devices from:', `${basePath}/api/devices`);
    
    fetch(`${basePath}/api/devices`)
        .then(response => response.json())
        .then(data => {
            console.log('Devices data:', data);
            devices = data.devices || [];
            console.log('Devices array:', devices);
            const grid = document.getElementById('device-grid');
            
            if (!grid) {
                console.error('device-grid element not found!');
                return;
            }
            
            if (devices.length === 0) {
                grid.innerHTML = '<div class="no-devices">No devices configured</div>';
                return;
            }
            
            console.log('Rendering devices:', devices.length, 'items');
            grid.innerHTML = devices.map(device => {
                console.log('Rendering device:', device);
                return `
                <div class="device-card" data-device-id="${device.id}">
                    <div class="device-header">
                        <h3 class="device-name">${device.name || 'Unknown Device'}</h3>
                        <span class="device-status status-${device.status || 'unknown'}">${device.status || 'unknown'}</span>
                    </div>
                    <div class="device-info">
                        <p><i class="fas fa-network-wired"></i> IP: ${device.ip}</p>
                        <p><i class="fas fa-ethernet"></i> Port: ${formatPortsWithProtocol(device.port)}</p>
                        <p><i class="fas fa-route"></i> Path: ${device.path || '/'}</p>
                        ${device.domain ? `<p><i class="fas fa-globe"></i> Domain: ${device.domain}</p>` : ''}
                        <p><i class="fas fa-link"></i> Access URL: <a href="https://${device.domain || 'akb001yebraxfqsm9y.dyndns-web.com'}${device.path || '/'}" target="_blank" style="color: #4a9eff;">https://${device.domain || 'akb001yebraxfqsm9y.dyndns-web.com'}${device.path || '/'}</a></p>
                    </div>
                    <div class="device-actions">
                        <button class="btn-icon" onclick="editDevice('${device.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" onclick="deleteDevice('${device.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading devices:', error);
            document.getElementById('device-grid').innerHTML = '<div class="error">Failed to load devices</div>';
        });
}

// Port protocol helper function
function getPortProtocol(port) {
    const portNum = parseInt(port);
    const protocols = {
        80: 'HTTP',
        443: 'HTTPS',
        8080: 'HTTP',
        8081: 'WS',
        8443: 'HTTPS',
        3000: 'HTTP',
        3001: 'API',
        5173: 'Dev',
        5432: 'PgSQL',
        6379: 'Redis',
        22: 'SSH',
        21: 'FTP',
        25: 'SMTP',
        110: 'POP3',
        143: 'IMAP',
        3306: 'MySQL',
        27017: 'MongoDB',
        9200: 'Elastic'
    };
    return protocols[portNum] || 'TCP';
}

// Format ports with protocol
function formatPortsWithProtocol(ports) {
    if (!ports) return '-';
    
    const portArray = Array.isArray(ports) ? ports : String(ports).split(',').map(p => p.trim());
    return portArray.map(port => {
        const protocol = getPortProtocol(port);
        return `<span class="port-item" title="${protocol}">${port}<small class="port-protocol">(${protocol})</small></span>`;
    }).join(' ');
}

// Format ports for input field
function formatPorts(ports) {
    if (!ports) return '';
    if (Array.isArray(ports)) {
        return ports.join(', ');
    }
    return String(ports);
}

// Update port helper text with protocols
function updatePortHelper() {
    const portInput = document.getElementById('devicePort');
    const helperText = document.getElementById('portHelperText');
    
    if (portInput && helperText) {
        const ports = portInput.value.split(',').map(p => p.trim()).filter(p => p);
        const protocols = ports.map(port => {
            const protocol = getPortProtocol(port);
            return `${port}(${protocol})`;
        });
        
        if (protocols.length > 0) {
            helperText.textContent = 'Protocols: ' + protocols.join(', ');
            helperText.style.color = 'var(--primary)';
        } else {
            helperText.textContent = 'Enter port numbers separated by commas (e.g., 80, 443, 8080)';
            helperText.style.color = 'var(--text-secondary)';
        }
    }
}


// showAddDeviceModal is defined later (line 770)

function editDevice(deviceId) {
    const device = devices.find(d => d.id === deviceId);
    if (!device) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Device';
    document.getElementById('deviceId').value = device.id;
    document.getElementById('deviceName').value = device.name || '';
    document.getElementById('deviceIp').value = device.ip || '';
    document.getElementById('devicePort').value = formatPorts(device.port);
    document.getElementById('devicePath').value = device.path || '/';
    document.getElementById('domainName').value = device.domain || 'akb001yebraxfqsm9y.dyndns-web.com';
    document.getElementById('deviceDescription').value = device.description || '';
    document.getElementById('deviceType').value = device.type || 'server';
    
    // Update port helper text
    updatePortHelper();
    
    document.getElementById('deviceModal').classList.add('show');
}

// モーダルを閉じる
function closeModal() {
    document.getElementById('deviceModal').classList.remove('show');
}

// デバイスを保存
function saveDevice() {
    const form = document.getElementById('deviceForm');
    if (!form) {
        console.error('Device form not found');
        return;
    }
    
    // Form validation
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Collect form data using name attributes
    const formData = {
        site_name: form.querySelector('[name="name"]').value.trim(),
        device_ip: form.querySelector('[name="ip_address"]').value.trim(),
        port: form.querySelector('[name="port"]').value.split(',').map(p => p.trim()).filter(p => p),
        path: normalizePath(form.querySelector('[name="path"]').value),
        domain_name: form.querySelector('[name="domain_name"]').value,
        description: form.querySelector('[name="description"]').value.trim(),
        type: form.querySelector('[name="device_type"]').value
    };
    
    // Validation
    if (!formData.site_name || !formData.device_ip) {
        alert('Device name and IP address are required');
        return;
    }
    
    // Check if editing or adding
    const deviceId = form.querySelector('[name="device_id"]').value;
    const basePath = window.location.pathname.includes('/lpg-admin') ? '/lpg-admin' : '';
    const url = deviceId ? `${basePath}/api/devices/${deviceId}` : `${basePath}/api/devices`;
    const method = deviceId ? 'PUT' : 'POST';
    
    console.log('Saving device:', formData);
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        if (result.success || result.status === 'success') {
            closeModal();
            loadDevices();
            alert(deviceId ? 'Device updated successfully' : 'Device added successfully');
        } else {
            alert('Error: ' + (result.error || result.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Save device error:', error);
        alert('Communication error: ' + error.message);
    });
}

// デバイスを削除
function deleteDevice(deviceId) {
    if (!confirm('Are you sure you want to delete this device?')) return;
    
    // URLのパスを適切に構築
    const basePath = window.location.pathname.includes('/lpg-admin') ? '/lpg-admin' : '';
    
    fetch(`${basePath}/api/devices/${deviceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success || result.status === 'success') {
            loadDevices();
            alert('Device deleted successfully');
        } else {
            alert('エラー: ' + (result.error || result.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('通信エラー: ' + error.message);
    });
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// モーダル外クリックで閉じる
document.getElementById('deviceModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Load domains into dropdown
function loadDomains() {
    const domainSelect = document.getElementById('domainName');
    
    // Keep the first option (placeholder)
    domainSelect.innerHTML = '<option value="">-- Select Domain --</option>';
    
    // Add the registered DDNS domain
    const option = document.createElement('option');
    option.value = 'akb001yebraxfqsm9y.dyndns-web.com';
    option.textContent = 'akb001yebraxfqsm9y.dyndns-web.com';
    domainSelect.appendChild(option);
    
    // Try to fetch additional registered domains from API
    const basePath = window.location.pathname.includes('/lpg-admin') ? '/lpg-admin' : '';
    fetch(`${basePath}/api/domains`)
        .then(response => response.json())
        .then(data => {
            // Add any additional domains from API that aren't already added
            if (data.domains) {
                data.domains.forEach(domain => {
                    if (domain.name !== 'akb001yebraxfqsm9y.dyndns-web.com') {
                        const option = document.createElement('option');
                        option.value = domain.name;
                        option.textContent = domain.name;
                        domainSelect.appendChild(option);
                    }
                });
            }
        })
        .catch(error => {
            console.log('Could not load additional domains:', error);
        });
}

// Update IP address based on domain selection
function updateIPFromDomain() {
    // This function is kept for compatibility but doesn't do anything
    // since DDNS domains don't automatically map to specific IP addresses
    updateFullPath();
}

// Update full path preview
function updateFullPath() {
    const domain = document.getElementById('domainName').value;
    const path = document.getElementById('devicePath').value || '/';
    const preview = document.getElementById('fullPathPreview');
    
    if (domain) {
        const fullPath = `https://${domain}${path}`;
        preview.textContent = `Full path: ${fullPath}`;
        
        // Check for path conflicts
        checkPathConflict(domain, path);
    } else {
        preview.textContent = 'Full path: (select domain first)';
    }
}

// Check if path already exists for the domain
function checkPathConflict(domain, path) {
    const deviceId = document.getElementById('deviceId').value;
    const preview = document.getElementById('fullPathPreview');
    
    // Check if any existing device has the same domain + path
    const conflict = devices.find(device => {
        return device.id !== deviceId && 
               (device.domain === domain || device.domain_name === domain) &&
               (device.path === path || device.registration_path === path);
    });
    
    if (conflict) {
        preview.innerHTML = `<span style="color: var(--accent-red);">⚠️ Path already registered for this domain</span>`;
    }
}

// Override the editDevice function to load domains
const originalEditDevice = editDevice;
editDevice = function(deviceId) {
    loadDomains();
    originalEditDevice(deviceId);
    
    // Set the domain value after a small delay to ensure dropdown is populated
    setTimeout(() => {
        const device = devices.find(d => d.id === deviceId);
        if (device) {
            document.getElementById('domainName').value = device.domain || '';
            updateFullPath();
        }
    }, 100);
};

// Define the showAddDeviceModal function for adding new devices
function showAddDeviceModal() {
    // Reset form for adding a new device
    document.getElementById('modalTitle').textContent = 'Add Device';
    document.getElementById('deviceId').value = '';
    document.getElementById('deviceName').value = '';
    document.getElementById('deviceIp').value = '';
    document.getElementById('devicePort').value = '';
    document.getElementById('devicePath').value = '/';
    document.getElementById('domainName').value = '';
    document.getElementById('deviceDescription').value = '';
    
    // Set default device type
    const deviceTypeSelect = document.getElementById('deviceType');
    if (deviceTypeSelect) {
        deviceTypeSelect.value = 'server';
    }
    
    // Show the modal
    const modal = document.getElementById('deviceModal');
    if (modal) {
        modal.classList.add('show');
    }
}

// Override showAddDeviceModal to load domains
const originalShowAddDeviceModal = showAddDeviceModal;
showAddDeviceModal = function() {
    loadDomains();
    originalShowAddDeviceModal();
};

// Additional initialization code - already handled in the main DOMContentLoaded above
</script>
{% endblock %}