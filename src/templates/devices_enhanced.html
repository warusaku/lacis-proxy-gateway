{% extends "base.html" %}

{% block title %}デバイス管理 - LPG Admin{% endblock %}

{% block content %}
<div class="container-lg">
    <div class="Header">
        <div class="Header-item">
            <h1 class="Header-link f3-light">デバイス管理</h1>
        </div>
        <div class="Header-item Header-item--full"></div>
        <div class="Header-item">
            <button class="btn btn-primary" onclick="showAddDeviceModal()">
                <svg class="octicon" width="16" height="16"><use href="#octicon-plus-16"></use></svg>
                デバイスルール追加
            </button>
        </div>
    </div>

    <!-- デバイスルール一覧 -->
    <div class="Box mt-4">
        <div class="Box-header">
            <h3 class="Box-title">設定済みルーティングルール</h3>
        </div>
        <div id="device-rules-list">
            <!-- JavaScriptで動的に生成 -->
        </div>
    </div>

    <!-- ルーティング概要 -->
    <div class="Box mt-4">
        <div class="Box-header">
            <h3 class="Box-title">ルーティング構成図</h3>
        </div>
        <div class="Box-body">
            <pre class="p-3 color-bg-subtle">
┌─────────────────────────────────────────────────┐
│  DDNS: akb001yebraxfqsm9y.dyndns-web.com       │
│  ↓                                              │
│  LPG (192.168.234.2)                            │
│  ├─ /lacisstack/boards → 192.168.234.10:80     │
│  ├─ /lacisstack/api    → 192.168.234.10:8080   │
│  └─ /lacisstack/boards/ws → 192.168.234.10:8081│
└─────────────────────────────────────────────────┘
            </pre>
        </div>
    </div>
</div>

<!-- デバイス追加モーダル -->
<div class="position-fixed top-0 left-0 width-full height-full d-flex flex-items-center flex-justify-center" 
     id="add-device-modal" style="display: none; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="Box Box--overlay" style="width: 600px; max-width: 90vw;">
        <div class="Box-header">
            <button class="Box-btn-octicon btn-octicon float-right" type="button" onclick="hideAddDeviceModal()">
                <svg class="octicon octicon-x" viewBox="0 0 16 16" width="16" height="16">
                    <path fill-rule="evenodd" d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.75.75 0 111.06 1.06L9.06 8l3.22 3.22a.75.75 0 11-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 01-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 010-1.06z"></path>
                </svg>
            </button>
            <h3 class="Box-title">デバイスルール追加</h3>
        </div>
        <form id="add-device-form">
            <div class="Box-body">
                <div class="form-group">
                    <div class="form-group-header">
                        <label for="domain-select">ドメイン</label>
                    </div>
                    <div class="form-group-body">
                        <select class="form-control" id="domain-select" name="domain" required>
                            <!-- JavaScriptで動的に生成 -->
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-group-header">
                        <label for="path-input">パス</label>
                    </div>
                    <div class="form-group-body">
                        <input type="text" class="form-control" id="path-input" name="path" 
                               placeholder="/lacisstack/service" required>
                        <p class="note">例: /lacisstack/boards, /lacisstack/api</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-group-header">
                        <label for="deviceip-input">デバイスIP</label>
                    </div>
                    <div class="form-group-body">
                        <input type="text" class="form-control" id="deviceip-input" name="deviceip" 
                               placeholder="192.168.234.10" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-group-header">
                        <label for="port-input">ポート</label>
                    </div>
                    <div class="form-group-body">
                        <input type="number" class="form-control" id="port-input" name="port" 
                               placeholder="80" min="1" max="65535" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-group-header">
                        <label for="sitename-input">サイト名</label>
                    </div>
                    <div class="form-group-body">
                        <input type="text" class="form-control" id="sitename-input" name="sitename" 
                               placeholder="whiteboard" required>
                        <p class="note">ログ識別用の名前</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-group-header">
                        <label>アクセス許可IP</label>
                    </div>
                    <div class="form-group-body">
                        <div class="form-checkbox">
                            <label>
                                <input type="checkbox" id="allow-any" onchange="toggleIPRestriction()">
                                すべてのIPを許可
                            </label>
                        </div>
                        <div id="ip-restriction-input" class="mt-2">
                            <input type="text" class="form-control" id="allowed-ips" 
                                   placeholder="192.168.3.0/24" value="192.168.3.0/24">
                            <p class="note">カンマ区切りで複数指定可能</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="Box-footer">
                <button type="submit" class="btn btn-primary">追加</button>
                <button type="button" class="btn" onclick="hideAddDeviceModal()">キャンセル</button>
            </div>
        </form>
    </div>
</div>

<script>
// 設定データ
let configData = null;

// ページ読み込み時
document.addEventListener('DOMContentLoaded', function() {
    loadConfig();
});

// 設定読み込み
function loadConfig() {
    fetch('/api/config')
        .then(response => response.json())
        .then(data => {
            configData = data;
            updateDeviceRulesList();
            updateDomainSelect();
        })
        .catch(error => {
            console.error('Error loading config:', error);
            showNotification('設定の読み込みに失敗しました', 'error');
        });
}

// デバイスルール一覧更新
function updateDeviceRulesList() {
    const container = document.getElementById('device-rules-list');
    container.innerHTML = '';
    
    for (const [domain, rules] of Object.entries(configData.hostingdevice || {})) {
        for (const [path, rule] of Object.entries(rules)) {
            if (rule.deviceip) {
                const ruleElement = createRuleElement(domain, path, rule);
                container.appendChild(ruleElement);
            }
        }
    }
    
    if (container.children.length === 0) {
        container.innerHTML = '<div class="blankslate"><p>デバイスルールが設定されていません</p></div>';
    }
}

// ルール要素作成
function createRuleElement(domain, path, rule) {
    const div = document.createElement('div');
    div.className = 'Box-row d-flex flex-items-center';
    
    div.innerHTML = `
        <div class="flex-auto">
            <strong>${domain}${path}</strong> → 
            <code>${rule.deviceip}:${rule.port[0] || 'N/A'}</code>
            <span class="Label ml-2">${rule.sitename}</span>
            <div class="text-small color-fg-muted">
                許可IP: ${rule.ips.join(', ')}
            </div>
        </div>
        <div>
            <button class="btn-sm btn-danger" onclick="deleteRule('${domain}', '${path}')">削除</button>
        </div>
    `;
    
    return div;
}

// ドメイン選択更新
function updateDomainSelect() {
    const select = document.getElementById('domain-select');
    select.innerHTML = '';
    
    for (const domain of Object.keys(configData.hostdomains || {})) {
        const option = document.createElement('option');
        option.value = domain;
        option.textContent = domain;
        select.appendChild(option);
    }
}

// モーダル表示
function showAddDeviceModal() {
    document.getElementById('add-device-modal').style.display = 'flex';
}

// モーダル非表示
function hideAddDeviceModal() {
    document.getElementById('add-device-modal').style.display = 'none';
    document.getElementById('add-device-form').reset();
}

// IPアクセス制限切り替え
function toggleIPRestriction() {
    const allowAny = document.getElementById('allow-any').checked;
    const ipInput = document.getElementById('ip-restriction-input');
    ipInput.style.display = allowAny ? 'none' : 'block';
}

// フォーム送信
document.getElementById('add-device-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const allowAny = document.getElementById('allow-any').checked;
    const allowedIps = allowAny ? ['any'] : 
                      document.getElementById('allowed-ips').value.split(',').map(ip => ip.trim());
    
    const data = {
        domain: formData.get('domain'),
        path: formData.get('path'),
        deviceip: formData.get('deviceip'),
        port: parseInt(formData.get('port')),
        sitename: formData.get('sitename'),
        ips: allowedIps
    };
    
    fetch('/api/devices', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showNotification('デバイスルールを追加しました', 'success');
            hideAddDeviceModal();
            loadConfig();
        } else {
            showNotification(result.message || 'エラーが発生しました', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('デバイスルールの追加に失敗しました', 'error');
    });
});

// ルール削除
function deleteRule(domain, path) {
    if (!confirm(`ルール "${domain}${path}" を削除しますか？`)) {
        return;
    }
    
    // 設定から削除
    delete configData.hostingdevice[domain][path];
    
    // 保存
    fetch('/api/config', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showNotification('ルールを削除しました', 'success');
            loadConfig();
        } else {
            showNotification('削除に失敗しました', 'error');
        }
    });
}

// 通知表示
function showNotification(message, type = 'info') {
    // 既存の通知を削除
    const existing = document.querySelector('.flash');
    if (existing) existing.remove();
    
    const flash = document.createElement('div');
    flash.className = `flash flash-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'warn'}`;
    flash.textContent = message;
    
    document.body.insertBefore(flash, document.body.firstChild);
    
    setTimeout(() => flash.remove(), 5000);
}
</script>

<style>
.Box--overlay {
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
</style>
{% endblock %}