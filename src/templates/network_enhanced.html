{% extends "base.html" %}

{% block title %}ネットワーク状態 - LPG Admin{% endblock %}

{% block content %}
<div class="Subhead">
    <h2 class="Subhead-heading">ネットワーク状態</h2>
    <div class="Subhead-actions">
        <button class="btn btn-primary" onclick="deployChanges()">
            <svg class="octicon mr-1" width="16" height="16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            Deploy Changes
        </button>
    </div>
</div>

<div class="d-flex flex-wrap">
    <!-- システムメトリクス -->
    <div class="Box mt-3 mr-3" style="flex: 1; min-width: 300px;">
        <div class="Box-header">
            <h3 class="Box-title">システムメトリクス</h3>
        </div>
        <div class="Box-body">
            <div class="mb-3">
                <h4 class="f5 text-normal">CPU使用率</h4>
                <div class="Progress">
                    <span class="Progress-item color-bg-success-emphasis" 
                          style="width: {{ metrics.cpu_usage }}%"></span>
                </div>
                <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.cpu_usage) }}%</p>
            </div>
            
            <div class="mb-3">
                <h4 class="f5 text-normal">メモリ使用率</h4>
                <div class="Progress">
                    <span class="Progress-item color-bg-success-emphasis" 
                          style="width: {{ metrics.memory_usage }}%"></span>
                </div>
                <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.memory_usage) }}%</p>
            </div>
            
            <div>
                <h4 class="f5 text-normal">総リクエスト数</h4>
                <p class="f2-light">{{ metrics.requests_total }}</p>
            </div>
        </div>
    </div>
    
    <!-- ネットワーク設定 -->
    <div class="Box mt-3" style="flex: 1; min-width: 300px;">
        <div class="Box-header">
            <h3 class="Box-title">ネットワーク設定</h3>
        </div>
        <div class="Box-body">
            <dl>
                <dt class="f5 text-normal">IPアドレス</dt>
                <dd class="color-fg-muted">192.168.234.2</dd>
                
                <dt class="f5 text-normal mt-3">VLAN</dt>
                <dd class="color-fg-muted">VLAN555 (lacis_proxy_gateway)</dd>
                
                <dt class="f5 text-normal mt-3">開放ポート</dt>
                <dd class="color-fg-muted">
                    <span class="Label mr-1">80 (HTTP)</span>
                    <span class="Label mr-1">443 (HTTPS)</span>
                    <span class="Label">8443 (Admin)</span>
                </dd>
                
                <dt class="f5 text-normal mt-3">プロキシ状態</dt>
                <dd>
                    <span class="Label Label--success">Running</span>
                </dd>
            </dl>
        </div>
    </div>
</div>

<!-- ネットワークトポロジー -->
<div class="Box mt-3">
    <div class="Box-header">
        <h3 class="Box-title">ネットワークトポロジー</h3>
    </div>
    <div class="Box-body">
        <div id="topology-diagram" class="d-flex flex-items-center flex-justify-center p-4">
            <svg width="800" height="400" viewBox="0 0 800 400" class="border color-border-subtle rounded-2">
                <!-- Internet Cloud -->
                <g id="internet">
                    <ellipse cx="100" cy="50" rx="60" ry="30" fill="#e1f5fe" stroke="#0277bd" stroke-width="2"/>
                    <text x="100" y="55" text-anchor="middle" class="f6">Internet</text>
                </g>
                
                <!-- DDNS -->
                <g id="ddns">
                    <rect x="250" y="30" width="140" height="40" rx="5" fill="#f3e5f5" stroke="#7b1fa2"/>
                    <text x="320" y="50" text-anchor="middle" class="f6">DDNS Gateway</text>
                    <text x="320" y="65" text-anchor="middle" class="f7 color-fg-muted">dyndns-web.com</text>
                </g>
                
                <!-- LPG Gateway -->
                <g id="lpg">
                    <rect x="280" y="140" width="120" height="60" rx="8" fill="#e8f5e8" stroke="#2e7d32" stroke-width="3"/>
                    <text x="340" y="165" text-anchor="middle" class="f5 text-bold">LPG Gateway</text>
                    <text x="340" y="180" text-anchor="middle" class="f6">192.168.234.2</text>
                    <text x="340" y="195" text-anchor="middle" class="f7 color-fg-muted">Port 80, 8443</text>
                </g>
                
                <!-- Internal Network -->
                <g id="internal-network">
                    <rect x="50" y="270" width="700" height="100" rx="10" fill="#fafafa" stroke="#d0d7de" stroke-dasharray="5,5"/>
                    <text x="70" y="290" class="f6 color-fg-muted">Internal Network (192.168.234.x)</text>
                </g>
                
                <!-- Orange Pi 5 Plus -->
                <g id="orangepi">
                    <rect x="150" y="300" width="120" height="50" rx="5" fill="#fff3e0" stroke="#f57c00"/>
                    <text x="210" y="320" text-anchor="middle" class="f6">Orange Pi 5+</text>
                    <text x="210" y="335" text-anchor="middle" class="f7 color-fg-muted">192.168.234.10</text>
                </g>
                
                <!-- API Server -->
                <g id="api-server">
                    <rect x="320" y="300" width="120" height="50" rx="5" fill="#e3f2fd" stroke="#1976d2"/>
                    <text x="380" y="320" text-anchor="middle" class="f6">API Server</text>
                    <text x="380" y="335" text-anchor="middle" class="f7 color-fg-muted">192.168.234.11</text>
                </g>
                
                <!-- LacisDrawBoards -->
                <g id="drawboards">
                    <rect x="530" y="300" width="120" height="50" rx="5" fill="#f1f8e9" stroke="#388e3c"/>
                    <text x="590" y="320" text-anchor="middle" class="f6">DrawBoards</text>
                    <text x="590" y="335" text-anchor="middle" class="f7 color-fg-muted">Port 8080</text>
                </g>
                
                <!-- Connection Lines -->
                <!-- Internet to DDNS -->
                <line x1="160" y1="50" x2="250" y2="50" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- DDNS to LPG -->
                <line x1="320" y1="70" x2="340" y2="140" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- LPG to devices -->
                <line x1="300" y1="200" x2="210" y2="300" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="340" y1="200" x2="380" y2="300" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="380" y1="200" x2="590" y2="300" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Arrow marker definition -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                    </marker>
                </defs>
                
                <!-- Route Labels -->
                <text x="150" y="250" class="f7 color-fg-accent">/lacisstack/boards</text>
                <text x="350" y="250" class="f7 color-fg-accent">/lacisstack/api</text>
                <text x="550" y="250" class="f7 color-fg-accent">/lacisstack/boards/ws</text>
            </svg>
        </div>
        
        <!-- Status Indicators -->
        <div class="d-flex flex-wrap mt-3">
            <div class="mr-4 mb-2">
                <span class="Label Label--success mr-1">●</span>
                <span class="f6">LPG Gateway (Active)</span>
            </div>
            <div class="mr-4 mb-2">
                <span class="Label Label--success mr-1">●</span>
                <span class="f6">DrawBoards Service</span>
            </div>
            <div class="mr-4 mb-2">
                <span class="Label Label--secondary mr-1">●</span>
                <span class="f6">API Server (Standby)</span>
            </div>
        </div>
    </div>
</div>

<!-- 接続テスト -->
<div class="Box mt-3">
    <div class="Box-header">
        <h3 class="Box-title">接続テスト</h3>
    </div>
    <div class="Box-body">
        <form id="testForm" class="d-flex">
            <input type="text" class="form-control flex-1" id="testUrl" 
                   placeholder="テストURL（例: http://192.168.234.10:8080）">
            <button type="submit" class="btn btn-primary ml-2">テスト実行</button>
        </form>
        <div id="testResult" class="mt-3"></div>
    </div>
</div>

<script>
// Deploy Changes Function
async function deployChanges() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    // ボタンを無効化してロード状態に
    button.disabled = true;
    button.innerHTML = `
        <svg class="octicon mr-1 anim-rotate" width="16" height="16" fill="currentColor">
            <path d="M8 0a8 8 0 110 16A8 8 0 018 0zM7 3a1 1 0 012 0v4a1 1 0 01-2 0V3zm0 8a1 1 0 012 0v2a1 1 0 01-2 0v-2z"/>
        </svg>
        Deploying...
    `;
    
    try {
        const response = await fetch('/api/system/deploy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'deploy_config'
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showNotification('設定が正常にデプロイされました', 'success');
            // ページを再読み込みして最新状態を反映
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(`デプロイに失敗しました: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('Deploy error:', error);
        showNotification('デプロイ中にエラーが発生しました', 'error');
    } finally {
        // ボタンを元に戻す
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Connection Test Form
document.getElementById('testForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = document.getElementById('testUrl').value;
    const resultDiv = document.getElementById('testResult');
    
    if (!url) {
        alert('URLを入力してください');
        return;
    }
    
    resultDiv.innerHTML = '<p class="color-fg-muted">テスト中...</p>';
    
    try {
        const response = await fetch('/api/system/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            resultDiv.innerHTML = `
                <div class="flash flash-success">
                    接続成功: ${data.result}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="flash flash-error">
                    接続失敗: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="flash flash-error">
                エラー: ${error}
            </div>
        `;
    }
});

// Notification function
function showNotification(message, type = 'info') {
    // 既存の通知を削除
    const existing = document.querySelector('.flash');
    if (existing) existing.remove();
    
    const flash = document.createElement('div');
    flash.className = `flash flash-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'warn'}`;
    flash.textContent = message;
    
    document.body.insertBefore(flash, document.body.firstChild);
    
    setTimeout(() => flash.remove(), 5000);
}

// メトリクス自動更新（10秒ごと）
setInterval(async () => {
    if (document.visibilityState === 'visible') {
        try {
            const response = await fetch('/api/system/status');
            const data = await response.json();
            // TODO: メトリクス更新処理
        } catch (error) {
            console.error('Failed to update metrics:', error);
        }
    }
}, 10000);
</script>

<style>
.anim-rotate {
    animation: rotate 1s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

#topology-diagram svg {
    background: #fafbfc;
}

.Label--success {
    background-color: #1f883d;
    color: white;
}

.Label--secondary {
    background-color: #656d76;
    color: white;
}
</style>
{% endblock %}