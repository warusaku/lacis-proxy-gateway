{% extends "base.html" %}

{% block title %}Domains{% endblock %}

{% block content %}
<div class="Subhead">
    <h2 class="Subhead-heading">ドメイン管理</h2>
    <div class="Subhead-actions">
        <button class="btn btn-primary btn-sm" onclick="showAddDomainModal()">
            + ドメイン追加
        </button>
    </div>
</div>

<div class="Box mt-3">
    <div class="Box-header">
        <h3 class="Box-title">登録済みドメイン</h3>
    </div>
    
    {% if config.hostdomains %}
        {% for domain, subnet in config.hostdomains.items() %}
        <div class="Box-row d-flex flex-justify-between flex-items-center">
            <div>
                <h4 class="f4 text-bold">{{ domain }}</h4>
                <p class="text-small color-fg-muted mb-0">
                    許可サブネット: {{ subnet }}
                </p>
                <p class="text-small color-fg-muted">
                    登録パス数: {{ config.hostingdevice.get(domain, {})|length }}
                </p>
            </div>
            <div>
                <span class="Label Label--success">Active</span>
                <button class="btn-sm btn-danger ml-2" onclick="deleteDomain('{{ domain }}')">
                    削除
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="Box-row">
            <p class="color-fg-muted">ドメインが登録されていません</p>
        </div>
    {% endif %}
</div>

<!-- Add Domain Modal -->
<div class="modal" id="addDomainModal" style="display: none;">
    <div class="modal-backdrop" onclick="hideAddDomainModal()"></div>
    <div class="modal-content">
        <div class="Box">
            <div class="Box-header">
                <h3 class="Box-title">ドメイン追加</h3>
            </div>
            <div class="Box-body">
                <form id="addDomainForm">
                    <div class="form-group">
                        <label for="domain">ドメイン名</label>
                        <input type="text" class="form-control" id="domain" 
                               placeholder="例: akb001yebraxfqsm9y.dyndns-web.com" required>
                    </div>
                    <div class="form-group">
                        <label for="subnet">許可サブネット</label>
                        <input type="text" class="form-control" id="subnet" 
                               placeholder="例: 192.168.234.0/24" required>
                    </div>
                </form>
            </div>
            <div class="Box-footer">
                <button class="btn btn-primary" onclick="addDomain()">追加</button>
                <button class="btn" onclick="hideAddDomainModal()">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
}
</style>

<script>
function showAddDomainModal() {
    document.getElementById('addDomainModal').style.display = 'block';
}

function hideAddDomainModal() {
    document.getElementById('addDomainModal').style.display = 'none';
    document.getElementById('addDomainForm').reset();
}

async function addDomain() {
    const domain = document.getElementById('domain').value;
    const subnet = document.getElementById('subnet').value;
    
    if (!domain || !subnet) {
        alert('すべての項目を入力してください');
        return;
    }
    
    try {
        const response = await fetch('/api/domains', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain, subnet})
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('ドメインが追加されました');
            location.reload();
        } else {
            alert('エラー: ' + data.message);
        }
    } catch (error) {
        alert('追加に失敗しました: ' + error);
    }
}

async function deleteDomain(domain) {
    if (!confirm(`${domain} を削除しますか？`)) return;
    
    // TODO: 削除API実装
    alert('削除機能は実装中です');
}
</script>
{% endblock %}