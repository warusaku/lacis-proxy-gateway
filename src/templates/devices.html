{% extends "base.html" %}

{% block title %}Devices{% endblock %}

{% block content %}
<div class="Subhead">
    <h2 class="Subhead-heading">デバイス管理</h2>
    <div class="Subhead-actions">
        <button class="btn btn-sm mr-2" onclick="refreshDevices()">
            <svg class="octicon mr-1" width="16" height="16" fill="currentColor">
                <path d="M1.679 7.932c.412-.621 1.242-1.75 2.366-2.717C5.175 4.242 6.527 3.5 8 3.5c1.473 0 2.824.742 3.955 1.715 1.124.967 1.954 2.096 2.366 2.717a.119.119 0 010 .136c-.412.621-1.242 1.75-2.366 2.717C10.825 11.758 9.473 12.5 8 12.5c-1.473 0-2.824-.742-3.955-1.715C2.921 9.818 2.091 8.689 1.679 8.068a.119.119 0 010-.136zM8 2c-1.981 0-3.67.992-4.933 2.078C1.797 5.169.88 6.423.43 7.1a1.619 1.619 0 000 1.798c.45.678 1.367 1.932 2.637 3.024C4.329 13.008 6.019 14 8 14c1.981 0 3.67-.992 4.933-2.078 1.27-1.092 2.187-2.346 2.637-3.024a1.619 1.619 0 000-1.798c-.45-.678-1.367-1.932-2.637-3.024C11.671 2.992 9.981 2 8 2zm2 6a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            更新
        </button>
        <button class="btn btn-primary btn-sm" onclick="showAddDeviceModal()">
            + ルール追加
        </button>
    </div>
</div>

<!-- デバイス統計 -->
<div class="d-flex flex-wrap mb-3">
    <div class="Box mr-3" style="min-width: 200px;">
        <div class="Box-header">
            <h3 class="Box-title">統計情報</h3>
        </div>
        <div class="Box-body">
            <dl class="d-flex">
                <div class="flex-1 text-center">
                    <dt class="f6 color-fg-muted">総IPアドレス</dt>
                    <dd class="f2-light" id="ip-count">{{ devices|groupby('ip_address')|list|length if devices else 0 }}</dd>
                </div>
                <div class="flex-1 text-center">
                    <dt class="f6 color-fg-muted">総デバイス数</dt>
                    <dd class="f2-light" id="device-count">{{ devices|length if devices else 0 }}</dd>
                </div>
                <div class="flex-1 text-center">
                    <dt class="f6 color-fg-muted">アクティブ</dt>
                    <dd class="f2-light color-fg-success" id="active-count">{{ devices|selectattr('status', 'equalto', 'active')|list|length if devices else 0 }}</dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<!-- IP別デバイスグループ -->
<div class="device-groups">
    {% if devices %}
        {% for ip_address, device_group in devices|groupby('ip_address') %}
        <div class="Box mb-3 device-group" data-ip="{{ ip_address }}">
            <div class="Box-header">
                <h3 class="Box-title d-flex flex-items-center">
                    <span class="status-indicator status-{{ 'healthy' if device_group|selectattr('status', 'equalto', 'active')|list else 'warning' }} mr-2"></span>
                    <span class="flex-1">{{ ip_address }}</span>
                    <span class="Counter mr-2">{{ device_group|list|length }}</span>
                    <details class="dropdown details-reset details-overlay">
                        <summary class="btn-sm btn" aria-haspopup="true">
                            <svg class="octicon" width="16" height="16" fill="currentColor">
                                <path d="M8 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM1.5 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm13 0a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                            </svg>
                        </summary>
                        <ul class="dropdown-menu dropdown-menu-sw">
                            <li><a class="dropdown-item" href="#" onclick="testConnection('{{ ip_address }}')">接続テスト</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showDeviceInfo('{{ ip_address }}')">詳細情報</a></li>
                        </ul>
                    </details>
                </h3>
            </div>
            <div class="Box-body">
                <div class="device-list">
                    {% for device in device_group %}
                    <div class="device-item d-flex flex-items-center py-2 border-bottom" data-device-id="{{ device.id or loop.index }}">
                        <div class="flex-1">
                            <div class="d-flex flex-items-center">
                                <h4 class="f5 text-bold mb-1">{{ device.device_name or device.sitename or 'Unknown Device' }}</h4>
                                <span class="Label Label--{{ 'success' if device.status == 'active' else 'secondary' }} ml-2">
                                    {{ device.status or 'unknown' }}
                                </span>
                            </div>
                            <div class="d-flex flex-items-center f6 color-fg-muted">
                                <span class="mr-3">
                                    <svg class="octicon mr-1" width="12" height="12" fill="currentColor">
                                        <path d="M1.5 3.25c0-.966.784-1.75 1.75-1.75h5.5c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 018.75 12.5h-5.5A1.75 1.75 0 011.5 10.75v-7.5zM3.25 2a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h5.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-5.5z"/>
                                    </svg>
                                    {{ device.registration_path or device.path or '/api' }}
                                </span>
                                <span class="mr-3">
                                    <svg class="octicon mr-1" width="12" height="12" fill="currentColor">
                                        <path d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"/>
                                    </svg>
                                    ポート: {{ device.port or 'N/A' }}
                                </span>
                                {% if device.domain_name %}
                                <span>
                                    <svg class="octicon mr-1" width="12" height="12" fill="currentColor">
                                        <path d="M8.5 0a.5.5 0 01.5.5v2a.5.5 0 01-.5.5h-2a.5.5 0 01-.5-.5v-2A.5.5 0 016.5 0h2zM3 5a.5.5 0 01.5-.5h9a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-9A.5.5 0 013 6V5z"/>
                                    </svg>
                                    {{ device.domain_name }}
                                </span>
                                {% endif %}
                            </div>
                            {% if device.last_seen %}
                            <div class="f7 color-fg-muted mt-1">
                                最終確認: {{ device.last_seen }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="d-flex flex-items-center">
                            {% if device.connection_count %}
                            <span class="Counter Counter--primary mr-2" title="アクティブ接続数">{{ device.connection_count }}</span>
                            {% endif %}
                            <button class="btn-sm btn" onclick="editDevice('{{ device.id or loop.index }}')">
                                編集
                            </button>
                            <button class="btn-sm btn-danger ml-1" onclick="deleteDevice('{{ device.id or loop.index }}')">
                                削除
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="Box">
        <div class="blankslate">
            <h3 class="blankslate-heading">デバイスが登録されていません</h3>
            <p>デバイスを追加して開始してください。</p>
            <button class="btn btn-primary" onclick="showAddDeviceModal()">最初のデバイスを追加</button>
        </div>
    </div>
    {% endif %}
</div>

<!-- レガシールーティングルール表示（折りたたみ） -->
<details class="Box mt-3">
    <summary class="Box-header">
        <h3 class="Box-title">ルーティングルール（レガシー表示）</h3>
    </summary>
    <div class="Box-body">
        <table class="table-responsive">
            <thead>
                <tr>
                    <th>ドメイン</th>
                    <th>パス</th>
                    <th>転送先IP</th>
                    <th>ポート</th>
                    <th>サイト名</th>
                    <th>許可IP</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for domain, paths in config.hostingdevice.items() %}
                    {% for path, rule in paths.items() %}
                    <tr>
                        <td>{{ domain }}</td>
                        <td>{{ path if path else '/' }}</td>
                        <td>{{ rule.deviceip if rule.deviceip else '-' }}</td>
                        <td>{{ rule.port|join(', ') if rule.port else '-' }}</td>
                        <td>{{ rule.sitename }}</td>
                        <td>
                            {% if rule.ips == ['any'] %}
                                <span class="Label">Any</span>
                            {% else %}
                                {{ rule.ips|join(', ') }}
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-sm btn-danger" onclick="deleteRule('{{ domain }}', '{{ path }}')">
                                削除
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>

<!-- Add Device Modal -->
<div class="modal" id="addDeviceModal" style="display: none;">
    <div class="modal-backdrop" onclick="hideAddDeviceModal()"></div>
    <div class="modal-content">
        <div class="Box">
            <div class="Box-header">
                <h3 class="Box-title">ルール追加</h3>
            </div>
            <div class="Box-body">
                <form id="addDeviceForm">
                    <div class="form-group">
                        <label for="domain">ドメイン</label>
                        <select class="form-control" id="domain" required>
                            <option value="">選択してください</option>
                            {% for domain in config.hostdomains.keys() %}
                            <option value="{{ domain }}">{{ domain }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="path">パス</label>
                        <input type="text" class="form-control" id="path" 
                               placeholder="例: /lacisstack/boards">
                    </div>
                    <div class="form-group">
                        <label for="deviceip">転送先IP</label>
                        <input type="text" class="form-control" id="deviceip" 
                               placeholder="例: 192.168.234.10" required>
                    </div>
                    <div class="form-group">
                        <label for="port">ポート</label>
                        <input type="number" class="form-control" id="port" 
                               placeholder="例: 8080" required>
                    </div>
                    <div class="form-group">
                        <label for="sitename">サイト名</label>
                        <input type="text" class="form-control" id="sitename" 
                               placeholder="例: whiteboard" required>
                    </div>
                    <div class="form-group">
                        <label for="ips">許可IP（カンマ区切り）</label>
                        <input type="text" class="form-control" id="ips" 
                               placeholder="例: 192.168.3.0/24, any">
                    </div>
                </form>
            </div>
            <div class="Box-footer">
                <button class="btn btn-primary" onclick="addDevice()">追加</button>
                <button class="btn" onclick="hideAddDeviceModal()">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
}

.table-responsive {
    width: 100%;
    border-collapse: collapse;
}

.table-responsive th,
.table-responsive td {
    padding: 8px 16px;
    text-align: left;
    border-bottom: 1px solid #30363d;
}

.table-responsive th {
    font-weight: 600;
    color: #8b949e;
}
</style>

<script>
// デバイス更新
async function refreshDevices() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = `
        <svg class="octicon mr-1 anim-rotate" width="16" height="16" fill="currentColor">
            <path d="M8 0a8 8 0 110 16A8 8 0 018 0zM7 3a1 1 0 012 0v4a1 1 0 01-2 0V3zm0 8a1 1 0 012 0v2a1 1 0 01-2 0v-2z"/>
        </svg>
        更新中...
    `;
    
    try {
        // ページを再読み込みして最新データを取得
        setTimeout(() => location.reload(), 500);
    } catch (error) {
        console.error('Refresh error:', error);
        showNotification('更新に失敗しました', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// 接続テスト
async function testConnection(ipAddress) {
    try {
        showNotification('接続テスト中...', 'info');
        const response = await fetch('/api/system/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ip: ipAddress,
                test_type: 'ping'
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification(`${ipAddress} への接続が確認できました`, 'success');
        } else {
            showNotification(`${ipAddress} への接続に失敗しました: ${data.message}`, 'error');
        }
    } catch (error) {
        showNotification('接続テストに失敗しました', 'error');
    }
}

// デバイス情報表示
function showDeviceInfo(ipAddress) {
    const deviceGroup = document.querySelector(`[data-ip="${ipAddress}"]`);
    if (deviceGroup) {
        deviceGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
        deviceGroup.style.border = '2px solid #0969da';
        setTimeout(() => {
            deviceGroup.style.border = '';
        }, 2000);
    }
}

// デバイス編集
function editDevice(deviceId) {
    // TODO: 編集機能実装
    showNotification('編集機能は実装中です', 'info');
}

// デバイス削除
async function deleteDevice(deviceId) {
    if (!confirm('このデバイスを削除しますか？')) return;
    
    try {
        const response = await fetch(`/api/devices/${deviceId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('デバイスが削除されました', 'success');
            // デバイス要素を削除
            const deviceElement = document.querySelector(`[data-device-id="${deviceId}"]`);
            if (deviceElement) {
                deviceElement.remove();
            }
        } else {
            showNotification('削除に失敗しました: ' + data.message, 'error');
        }
    } catch (error) {
        showNotification('削除に失敗しました', 'error');
    }
}

function showAddDeviceModal() {
    document.getElementById('addDeviceModal').style.display = 'block';
}

function hideAddDeviceModal() {
    document.getElementById('addDeviceModal').style.display = 'none';
    document.getElementById('addDeviceForm').reset();
}

async function addDevice() {
    const domain = document.getElementById('domain').value;
    const path = document.getElementById('path').value || '';
    const deviceip = document.getElementById('deviceip').value;
    const port = document.getElementById('port').value;
    const sitename = document.getElementById('sitename').value;
    const ipsInput = document.getElementById('ips').value || 'any';
    const ips = ipsInput.split(',').map(ip => ip.trim()).filter(ip => ip);
    
    if (!domain || !deviceip || !port || !sitename) {
        alert('必須項目を入力してください');
        return;
    }
    
    try {
        const response = await fetch('/api/devices', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                domain, path, deviceip, port, sitename, ips
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('ルールが追加されました', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('エラー: ' + data.message, 'error');
        }
    } catch (error) {
        showNotification('追加に失敗しました: ' + error, 'error');
    }
}

async function deleteRule(domain, path) {
    if (!confirm('このルールを削除しますか？')) return;
    
    try {
        const response = await fetch('/api/devices/rule', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ domain, path })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('ルールが削除されました', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('削除に失敗しました: ' + data.message, 'error');
        }
    } catch (error) {
        showNotification('削除に失敗しました', 'error');
    }
}
</script>
{% endblock %}