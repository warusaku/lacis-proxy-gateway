{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="Subhead">
    <h2 class="Subhead-heading">設定</h2>
</div>

<!-- タブナビゲーション -->
<nav class="UnderlineNav mt-3">
    <div class="UnderlineNav-body">
        <a class="UnderlineNav-item selected" href="#system" onclick="showTab('system')">
            システム情報
        </a>
        <a class="UnderlineNav-item" href="#lacis" onclick="showTab('lacis')">
            Lacis設定
        </a>
        <a class="UnderlineNav-item" href="#basic" onclick="showTab('basic')">
            基本設定
        </a>
        <a class="UnderlineNav-item" href="#backup" onclick="showTab('backup')">
            バックアップ
        </a>
        <a class="UnderlineNav-item" href="#logs" onclick="showTab('logs')">
            ログ設定
        </a>
        <a class="UnderlineNav-item" href="#advanced" onclick="showTab('advanced')">
            詳細設定
        </a>
    </div>
</nav>

<!-- システム情報タブ -->
<div id="system-tab" class="tab-content">
    <div class="d-flex flex-wrap">
        <!-- システム状態 -->
        <div class="Box mr-3 mb-3" style="flex: 1; min-width: 300px;">
            <div class="Box-header">
                <h3 class="Box-title">システム状態</h3>
            </div>
            <div class="Box-body">
                <dl>
                    <dt class="f6 color-fg-muted">LPG バージョン</dt>
                    <dd class="mb-2">{{ system_info.version or 'v1.0.0' }}</dd>
                    
                    <dt class="f6 color-fg-muted">アップタイム</dt>
                    <dd class="mb-2">{{ system_info.uptime or 'N/A' }}</dd>
                    
                    <dt class="f6 color-fg-muted">システムID</dt>
                    <dd class="mb-2">
                        <code class="f6">{{ system_info.system_id or 'lpg-001' }}</code>
                        <button class="btn-sm btn ml-2" onclick="copyToClipboard('{{ system_info.system_id or "lpg-001" }}')">
                            コピー
                        </button>
                    </dd>
                    
                    <dt class="f6 color-fg-muted">プロキシポート</dt>
                    <dd class="mb-2">{{ config.proxy_port or '80, 443' }}</dd>
                    
                    <dt class="f6 color-fg-muted">管理ポート</dt>
                    <dd class="mb-0">{{ config.admin_port or '8443' }}</dd>
                </dl>
            </div>
        </div>
        
        <!-- ネットワーク情報 -->
        <div class="Box mb-3" style="flex: 1; min-width: 300px;">
            <div class="Box-header">
                <h3 class="Box-title">ネットワーク情報</h3>
            </div>
            <div class="Box-body">
                <dl>
                    <dt class="f6 color-fg-muted">プライベートIP</dt>
                    <dd class="mb-2">{{ network_info.private_ip or '192.168.234.2' }}</dd>
                    
                    <dt class="f6 color-fg-muted">パブリックIP</dt>
                    <dd class="mb-2">
                        <span id="public-ip">{{ network_info.public_ip or '取得中...' }}</span>
                        <button class="btn-sm btn ml-2" onclick="refreshPublicIP()">更新</button>
                    </dd>
                    
                    <dt class="f6 color-fg-muted">DDNS エンドポイント</dt>
                    <dd class="mb-2">{{ config.ddns_endpoint or 'dyndns-web.com' }}</dd>
                    
                    <dt class="f6 color-fg-muted">DNS レコード</dt>
                    <dd class="mb-0">
                        {% for domain in config.hostdomains.keys() %}
                        <div class="mb-1">{{ domain }}</div>
                        {% endfor %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
    
    <!-- リソース使用状況 -->
    <div class="Box">
        <div class="Box-header">
            <h3 class="Box-title">リソース使用状況</h3>
        </div>
        <div class="Box-body">
            <div class="d-flex flex-wrap">
                <div class="flex-1 mr-3">
                    <h4 class="f5 text-normal mb-2">CPU使用率</h4>
                    <div class="Progress">
                        <span class="Progress-item" id="cpu-progress" 
                              style="width: {{ metrics.cpu_usage or 0 }}%; background-color: {{ '#3fb950' if (metrics.cpu_usage or 0) < 70 else ('#d29922' if (metrics.cpu_usage or 0) < 90 else '#f85149') }}"></span>
                    </div>
                    <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.cpu_usage or 0) }}%</p>
                </div>
                
                <div class="flex-1 mr-3">
                    <h4 class="f5 text-normal mb-2">メモリ使用率</h4>
                    <div class="Progress">
                        <span class="Progress-item" id="memory-progress" 
                              style="width: {{ metrics.memory_usage or 0 }}%; background-color: {{ '#3fb950' if (metrics.memory_usage or 0) < 70 else ('#d29922' if (metrics.memory_usage or 0) < 90 else '#f85149') }}"></span>
                    </div>
                    <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.memory_usage or 0) }}%</p>
                </div>
                
                <div class="flex-1">
                    <h4 class="f5 text-normal mb-2">ディスク使用率</h4>
                    <div class="Progress">
                        <span class="Progress-item" id="disk-progress" 
                              style="width: {{ metrics.disk_usage or 0 }}%; background-color: {{ '#3fb950' if (metrics.disk_usage or 0) < 70 else ('#d29922' if (metrics.disk_usage or 0) < 90 else '#f85149') }}"></span>
                    </div>
                    <p class="text-small color-fg-muted mt-1">{{ "%.1f"|format(metrics.disk_usage or 0) }}%</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lacis設定タブ -->
<div id="lacis-tab" class="tab-content" style="display: none;">
    <div class="d-flex flex-wrap">
        <!-- Lacis接続設定 -->
        <div class="Box mr-3 mb-3" style="flex: 1; min-width: 350px;">
            <div class="Box-header">
                <h3 class="Box-title">Lacis接続設定</h3>
            </div>
            <div class="Box-body">
                <form id="lacisForm">
                    <div class="form-group">
                        <label for="lacisEndpoint">Lacis エンドポイント</label>
                        <input type="url" class="form-control" id="lacisEndpoint" 
                               value="{{ config.endpoint.lacis or 'https://api.lacis.cloud' }}"
                               placeholder="https://api.lacis.cloud">
                        <p class="text-small color-fg-muted mt-1">
                            Lacis APIサーバーのエンドポイントURL
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="lacisId">Lacis ID</label>
                        <div class="d-flex">
                            <input type="text" class="form-control" id="lacisId" 
                                   value="{{ config.lacis_id or 'lpg-' + system_info.system_id|default('001') }}"
                                   placeholder="lpg-001">
                            <button type="button" class="btn btn-sm ml-2" onclick="generateLacisId()">
                                生成
                            </button>
                        </div>
                        <p class="text-small color-fg-muted mt-1">
                            Lacisシステム内でのユニークな識別子
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="lacisApiKey">API キー</label>
                        <div class="d-flex">
                            <input type="password" class="form-control" id="lacisApiKey" 
                                   value="{{ config.lacis_api_key or '' }}"
                                   placeholder="API キーを入力">
                            <button type="button" class="btn btn-sm ml-2" onclick="toggleApiKeyVisibility()">
                                <span id="apiKeyToggleText">表示</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lacisHeartbeat">ハートビート間隔（秒）</label>
                        <input type="number" class="form-control" id="lacisHeartbeat" 
                               value="{{ config.lacis_heartbeat or 60 }}" min="30" max="300">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Lacis設定を保存</button>
                    <button type="button" class="btn btn-sm ml-2" onclick="testLacisConnection()">
                        接続テスト
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Lacis状態 -->
        <div class="Box mb-3" style="flex: 1; min-width: 300px;">
            <div class="Box-header">
                <h3 class="Box-title">Lacis接続状態</h3>
            </div>
            <div class="Box-body">
                <dl>
                    <dt class="f6 color-fg-muted">接続状態</dt>
                    <dd class="mb-2">
                        <span class="Label Label--{{ 'success' if lacis_status.connected else 'secondary' }}">
                            {{ '接続済み' if lacis_status.connected else '切断' }}
                        </span>
                    </dd>
                    
                    <dt class="f6 color-fg-muted">最終ハートビート</dt>
                    <dd class="mb-2">{{ lacis_status.last_heartbeat or 'N/A' }}</dd>
                    
                    <dt class="f6 color-fg-muted">登録デバイス数</dt>
                    <dd class="mb-2">{{ lacis_status.registered_devices or 0 }}</dd>
                    
                    <dt class="f6 color-fg-muted">データ送信レート</dt>
                    <dd class="mb-2">{{ lacis_status.data_rate or '0 KB/s' }}</dd>
                    
                    <dt class="f6 color-fg-muted">エラー数（24h）</dt>
                    <dd class="mb-0">
                        <span class="color-fg-danger">{{ lacis_status.error_count or 0 }}</span>
                    </dd>
                </dl>
                
                {% if lacis_status.last_error %}
                <div class="flash flash-error mt-3">
                    <strong>最新エラー:</strong><br>
                    {{ lacis_status.last_error }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Lacisデバイス登録 -->
    <div class="Box">
        <div class="Box-header">
            <h3 class="Box-title">デバイス登録状況</h3>
        </div>
        <div class="Box-body">
            {% if lacis_devices %}
            <div class="table-responsive">
                <table class="width-full">
                    <thead>
                        <tr>
                            <th class="f6 color-fg-muted p-2">デバイス名</th>
                            <th class="f6 color-fg-muted p-2">Lacis ID</th>
                            <th class="f6 color-fg-muted p-2">状態</th>
                            <th class="f6 color-fg-muted p-2">最終更新</th>
                            <th class="f6 color-fg-muted p-2">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in lacis_devices %}
                        <tr>
                            <td class="p-2">{{ device.name }}</td>
                            <td class="p-2">
                                <code class="f6">{{ device.lacis_id }}</code>
                            </td>
                            <td class="p-2">
                                <span class="Label Label--{{ 'success' if device.status == 'active' else 'secondary' }}">
                                    {{ device.status }}
                                </span>
                            </td>
                            <td class="p-2 f7 color-fg-muted">{{ device.last_update }}</td>
                            <td class="p-2">
                                <button class="btn-sm btn" onclick="syncDeviceToLacis('{{ device.id }}')">
                                    同期
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="blankslate">
                <h3 class="blankslate-heading">Lacisに登録されたデバイスがありません</h3>
                <p>デバイスを登録すると、Lacisクラウドとの統合が有効になります。</p>
                <button class="btn btn-primary" onclick="registerAllDevices()">
                    全デバイスを登録
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 基本設定タブ -->
<div id="basic-tab" class="tab-content" style="display: none;">
    <div class="Box mt-3">
        <div class="Box-header">
            <h3 class="Box-title">管理者設定</h3>
        </div>
        <div class="Box-body">
            <form id="adminForm">
                <div class="form-group">
                    <label for="adminPassword">新しいパスワード</label>
                    <input type="password" class="form-control" id="adminPassword">
                </div>
                <div class="form-group">
                    <label for="adminPasswordConfirm">パスワード確認</label>
                    <input type="password" class="form-control" id="adminPasswordConfirm">
                </div>
                <button type="submit" class="btn btn-primary">パスワード変更</button>
            </form>
        </div>
    </div>
</div>

<!-- バックアップタブ -->
<div id="backup-tab" class="tab-content" style="display: none;">
    <div class="Box mt-3">
        <div class="Box-header">
            <h3 class="Box-title">設定バックアップ</h3>
        </div>
        <div class="Box-body">
            <div class="mb-3">
                <button class="btn btn-primary" onclick="downloadConfig()">
                    設定をダウンロード
                </button>
                <button class="btn ml-2" onclick="showUploadModal()">
                    設定をアップロード
                </button>
            </div>
            
            <h4 class="f5 mt-4">バックアップ履歴</h4>
            <p class="color-fg-muted text-small">
                設定変更時に自動的にバックアップが作成されます（最大5世代）
            </p>
        </div>
    </div>
</div>

<!-- ログ設定タブ -->
<div id="logs-tab" class="tab-content" style="display: none;">
    <div class="Box mt-3">
        <div class="Box-header">
            <h3 class="Box-title">ログ設定</h3>
        </div>
        <div class="Box-body">
            <form id="logForm">
                <div class="form-group">
                    <label for="logServer">ログサーバーエンドポイント</label>
                    <input type="url" class="form-control" id="logServer" 
                           value="{{ config.endpoint.logserver }}"
                           placeholder="https://example.com/logs">
                </div>
                <div class="form-group">
                    <label for="logInterval">送信間隔（分）</label>
                    <input type="number" class="form-control" id="logInterval" 
                           value="15" min="1" max="60">
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
</div>

<!-- 詳細設定タブ -->
<div id="advanced-tab" class="tab-content" style="display: none;">
    <div class="Box mt-3">
        <div class="Box-header">
            <h3 class="Box-title">JSON設定エディタ</h3>
        </div>
        <div class="Box-body">
            <div class="form-group">
                <label for="configJson">設定JSON</label>
                <textarea class="form-control" id="configJson" rows="20" 
                          style="font-family: monospace;">{{ config|tojson(indent=2) }}</textarea>
            </div>
            <button class="btn btn-primary" onclick="saveJsonConfig()">
                JSON設定を保存
            </button>
            <p class="color-fg-muted text-small mt-2">
                ⚠️ 注意: 不正な設定を保存するとシステムが動作しなくなる可能性があります
            </p>
        </div>
    </div>
</div>

<style>
.tab-content {
    margin-top: 20px;
}

.UnderlineNav-item {
    cursor: pointer;
}
</style>

<script>
function showTab(tabName) {
    // すべてのタブを非表示
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // すべてのタブリンクから selected クラスを削除
    document.querySelectorAll('.UnderlineNav-item').forEach(link => {
        link.classList.remove('selected');
    });
    
    // 選択されたタブを表示
    document.getElementById(tabName + '-tab').style.display = 'block';
    
    // 選択されたリンクに selected クラスを追加
    event.target.classList.add('selected');
}

// システム情報関連
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('クリップボードにコピーしました', 'success');
    }).catch(() => {
        showNotification('コピーに失敗しました', 'error');
    });
}

async function refreshPublicIP() {
    try {
        const response = await fetch('/api/system/public-ip');
        const data = await response.json();
        
        if (data.ip) {
            document.getElementById('public-ip').textContent = data.ip;
            showNotification('パブリックIPを更新しました', 'success');
        } else {
            showNotification('パブリックIPの取得に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('パブリックIPの取得に失敗しました', 'error');
    }
}

// Lacis設定関連
function generateLacisId() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 5);
    const lacisId = `lpg-${timestamp}${random}`;
    document.getElementById('lacisId').value = lacisId;
}

function toggleApiKeyVisibility() {
    const apiKeyInput = document.getElementById('lacisApiKey');
    const toggleText = document.getElementById('apiKeyToggleText');
    
    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        toggleText.textContent = '隠す';
    } else {
        apiKeyInput.type = 'password';
        toggleText.textContent = '表示';
    }
}

async function testLacisConnection() {
    const endpoint = document.getElementById('lacisEndpoint').value;
    const lacisId = document.getElementById('lacisId').value;
    const apiKey = document.getElementById('lacisApiKey').value;
    
    if (!endpoint || !lacisId) {
        showNotification('エンドポイントとLacis IDは必須です', 'error');
        return;
    }
    
    try {
        showNotification('Lacis接続をテスト中...', 'info');
        
        const response = await fetch('/api/lacis/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                endpoint,
                lacis_id: lacisId,
                api_key: apiKey
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Lacis接続テストが成功しました', 'success');
        } else {
            showNotification(`Lacis接続テストに失敗しました: ${data.message}`, 'error');
        }
    } catch (error) {
        showNotification('Lacis接続テストに失敗しました', 'error');
    }
}

async function syncDeviceToLacis(deviceId) {
    try {
        showNotification('デバイスを同期中...', 'info');
        
        const response = await fetch(`/api/lacis/sync/${deviceId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('デバイス同期が完了しました', 'success');
        } else {
            showNotification(`デバイス同期に失敗しました: ${data.message}`, 'error');
        }
    } catch (error) {
        showNotification('デバイス同期に失敗しました', 'error');
    }
}

async function registerAllDevices() {
    if (!confirm('全てのデバイスをLacisに登録しますか？')) return;
    
    try {
        showNotification('全デバイスを登録中...', 'info');
        
        const response = await fetch('/api/lacis/register-all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification(`${data.registered_count}台のデバイスを登録しました`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification(`デバイス登録に失敗しました: ${data.message}`, 'error');
        }
    } catch (error) {
        showNotification('デバイス登録に失敗しました', 'error');
    }
}

// Lacis設定フォーム
document.getElementById('lacisForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const endpoint = document.getElementById('lacisEndpoint').value;
    const lacisId = document.getElementById('lacisId').value;
    const apiKey = document.getElementById('lacisApiKey').value;
    const heartbeat = document.getElementById('lacisHeartbeat').value;
    
    try {
        const response = await fetch('/api/lacis/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                endpoint,
                lacis_id: lacisId,
                api_key: apiKey,
                heartbeat: parseInt(heartbeat)
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Lacis設定を保存しました', 'success');
        } else {
            showNotification(`設定保存に失敗しました: ${data.message}`, 'error');
        }
    } catch (error) {
        showNotification('設定保存に失敗しました', 'error');
    }
});

// リソース使用状況の自動更新
setInterval(async () => {
    if (document.visibilityState === 'visible' && document.getElementById('system-tab').style.display !== 'none') {
        try {
            const response = await fetch('/api/system/metrics');
            const data = await response.json();
            
            if (data.metrics) {
                updateResourceProgress('cpu-progress', data.metrics.cpu_usage);
                updateResourceProgress('memory-progress', data.metrics.memory_usage);
                updateResourceProgress('disk-progress', data.metrics.disk_usage);
            }
        } catch (error) {
            console.error('Failed to update metrics:', error);
        }
    }
}, 5000);

function updateResourceProgress(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.width = `${value}%`;
        
        // 色を使用率に応じて変更
        let color = '#3fb950'; // 緑
        if (value >= 90) color = '#f85149'; // 赤
        else if (value >= 70) color = '#d29922'; // 黄
        
        element.style.backgroundColor = color;
        
        // 隣接するテキストも更新
        const textElement = element.parentElement.nextElementSibling;
        if (textElement) {
            textElement.textContent = `${value.toFixed(1)}%`;
        }
    }
}

// パスワード変更
document.getElementById('adminForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const password = document.getElementById('adminPassword').value;
    const confirm = document.getElementById('adminPasswordConfirm').value;
    
    if (password !== confirm) {
        alert('パスワードが一致しません');
        return;
    }
    
    if (password.length < 8) {
        alert('パスワードは8文字以上にしてください');
        return;
    }
    
    // TODO: パスワード変更API実装
    alert('パスワード変更機能は実装中です');
});

// ログ設定保存
document.getElementById('logForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const logServer = document.getElementById('logServer').value;
    
    try {
        const config = await fetch('/api/config').then(r => r.json());
        config.endpoint.logserver = logServer;
        
        const response = await fetch('/api/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('ログ設定を保存しました');
        } else {
            alert('エラー: ' + data.message);
        }
    } catch (error) {
        alert('保存に失敗しました: ' + error);
    }
});

// 設定ダウンロード
async function downloadConfig() {
    try {
        const config = await fetch('/api/config').then(r => r.json());
        const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lpg-config-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        alert('ダウンロードに失敗しました: ' + error);
    }
}

// JSON設定保存
async function saveJsonConfig() {
    try {
        const configText = document.getElementById('configJson').value;
        const config = JSON.parse(configText);
        
        const response = await fetch('/api/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('設定を保存しました');
        } else {
            alert('エラー: ' + data.message);
        }
    } catch (error) {
        alert('JSONパースエラー: ' + error);
    }
}
</script>
{% endblock %}