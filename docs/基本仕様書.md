---
title: LacisProxyGateway
projects:
- LPG
tags:
- '#proj-lpg'
created: '2025-07-28'
updated: '2025-08-02'
author: unknown
status: draft
---
# LacisProxyGateway

**― Orange Pi Zero 3 ベース「リバースプロキシ＋ルーティング」アプライアンス 詳細仕様書 ―**
作成日 : 2025‑07‑26

---

## 1. 目的と全体像

| 項目        | 内容                                                                                                               |
| --------- | ---------------------------------------------------------------------------------------------------------------- |
| 名称        | **LacisProxyGateway (LPG)**                                                                                      |
| 目的        | Omada SDN 直下に置き、<br>① 外部 HTTP/HTTPS/WebSocket トラフィックを全て収容<br>② DDNS ホスト名・パスでローカル機器へ振り分け<br>③ VLAN 間ポリシー・ログ監視を一元化 |
| ハード       | Orange Pi Zero 3 (H618 / 4 GB RAM / eMMC または Class‑10 SD)                                                        |
| OS        | Armbian 24.5 LTS (Ubuntu 22.04 arm64 カーネル 6.x)                                                                   |
| 主要コンポーネント | *Caddy 2*（HTTPS 終端 & リバースプロキシ）<br>*iptables‑nft*（ポリシールーティング）<br>*Telegraf*（監視エージェント）                             |
| UI        | 内蔵 HTTP サーバー（ポート 8443）<br>React + Primer/GitHub DesignSystem 準拠                                                  |
| 可搬構成      | 設定は **単一 JSON ファイル** に集約しホットリロード対応                                                                               |

---

## 2. ネットワーク設計

```
                 ┌─────────── WAN (ISP) ────────────┐
                 ▼                                  │
          ┌──────────────┐        (CG‑NAT可)        │
          │  Omada GW    │ 192.168.3.1/24  (vlan1)  │
          │ (ER7206 等)  │───────────────────────────┤
          └─────┬────────┘                          │
                │ DNAT 80/443 → 192.168.234.2       │
vlan1            │                                  │
(192.168.3.0/24) │                                  │
─────────────────┘                                  │
         (許可: → vlan555 のみ)                     │
                                                    │
       ┌────────────────────────────────────────────┤
vlan555│            192.168.234.0/24 「lacisstack」 │
        ╞═══════════════════════════════════════════╡
        │ Orange Pi Zero 3 = **LacisProxyGateway**  │
        │  • eth0: 192.168.234.2                    │
        │  • Caddy :80/443 (外向け)                 │
        │  • Admin UI :8443 (LAN 限定)              │
        │  • Systemd‑service: cloudflared (任意)    │
        │  • tldraw‑Sync などローカル機器           │
        ╘═══════════════════════════════════════════╡
                ▲                                  │
                │  policy‑route (vlan1 ← 片方向)    │
                │                                  │
           他 vlan555 デバイス                      │
```

### 2.1 VLANポリシー管理

**重要**: VLANアクセス制御とポリシールーティングは**Omadaクラウドコントローラー**で一元管理します。

* **vlan555 → vlan1 は禁止**
  Omada ACL（アクセス制御リスト）で設定
* **vlan1 → vlan555 は 80/443 (＋必要 WS ポート) のみ許可**
  Omada ACLで設定

LPG自体は最小限のセキュリティルールのみを実装し、主要なネットワークポリシーはOmada側で管理することで、設定の一元化と管理の簡素化を実現します。

---

## 3. ソフトウェア構成

| レイヤ      | コンポーネント                     | バージョン              | 主な設定                                                 |
| -------- | --------------------------- | ------------------ | ---------------------------------------------------- |
| OS       | Armbian 24.5 (Ubuntu 22.04) | LTS                | read‑only rootFS オプション可                              |
| リバースプロキシ | **Caddy 2.8**               | 公式 arm64 ビルド       | *JSON API* を UI から操作<br>自動 Let's Encrypt + ECDSA 証明書 |
| セキュリティ    | 基本iptablesルール             | -                  | DDoS対策の基本ルールのみ（VLANポリシーはOmada管理）                    |
| 管理 UI    | React 18 + Primer CSS       | 内蔵 Go HTTP on 8443 | JWT セッション / HTTPS 強制                                 |
| 監視       | Telegraf + tail/exec input  | 1.31               | JSON ログを **endpoint.logserver** へ 15 min batch POST  |
| オプション    | cloudflared                 | 2025.7             | DDNS を Cloudflare に移行可能                              |

---

## 4. 設定ファイル仕様（`/etc/lpg/config.json`）

**更新: 2025-08-02** - 動的設定読み込み、MIME Type自動修正、管理UI強化

### 4.0 主な機能強化
- **ホットリロード対応**: 設定ファイル変更を自動検出し、サービス再起動不要で反映
- **MIME Type自動修正**: JavaScriptファイルの誤ったContent-Type問題を自動解決
- **拡張管理UI**: デバイスルールの追加・削除をWeb UIから簡単操作
- **パス書き換え機能**: プレフィックス除去によるバックエンド互換性向上

```jsonc
{
  "hostdomains": {                    // FQDN ↔ 許可サブネット
    "akb001yebraxfqsm9y.dyndns-web.com": "192.168.234.0/24"
  },

  "hostingdevice": {                  // FQDN 単位のルール木
    "akb001yebraxfqsm9y.dyndns-web.com": {
      "": {                           // ルートパス
        "deviceip": "",               // 空: 既存サービスへパススルー
        "port": [],                   
        "sitename": "root",
        "ips": ["192.168.3.0/24"]
      },
      "/lacisstack": {                // LacisStackサービスのベースパス
        "deviceip": "",
        "port": [],
        "sitename": "lacisstack-root",
        "ips": ["192.168.3.0/24"]
      },
      "/lacisstack/boards": {         // ホワイトボード
        "deviceip": "192.168.234.10",
        "port": [8080],
        "sitename": "whiteboard",
        "ips": ["192.168.3.0/24"]     // VLAN1からのみアクセス可能
      },
      "/lacisstack/boards/ws": {      // WebSocket接続
        "deviceip": "192.168.234.10",
        "port": [8081],
        "sitename": "whiteboard-ws",
        "ips": ["192.168.3.0/24"]
      },
      "/lacisstack/api": {            // APIサーバー
        "deviceip": "192.168.234.10",
        "port": [3000],
        "sitename": "api-server",
        "ips": ["any"]                // 外部APIアクセス許可
      }
    }
  },

  "adminuser": {
    "lacisadmin": "$argon2id$v=19$m=16,t=2,p=1$..."  // Argon2 ハッシュ
  },

  "endpoint": {
    "logserver": "https://www.example.com/logs"
  },

  "options": {                        // 拡張用 (将来)
    "websocket_timeout": 600,
    "log_retention_days": 30
  }
}
```

### 4.1 ルール解決フロー

1. `Host` ヘッダで **hostdomains** キーを検索

   * 存在しなければ 444 (TCP reset)
2. `Path` を最長一致で **hostingdevice\[host]** のキー検索
3. 許可 IP リスト (`ips`) を照合
4. マッチしたら `deviceip:port` へ `proxy_pass`（WebSocket 自動昇格）
5. ログを `sitename` 単位で JSON 出力 → バッチ送信

### 4.2 追加／編集

* UI で「＋Add Domain」「＋Add Path」ボタンを用意
* 変更時は **Caddy Admin API** (`/config/`) にパッチ適用し即時反映
* JSON スキーマは `schemas/config.schema.json` (OpenAPI‑style) でバリデート

---

## 5. 管理 UI

| 項目 | 要件                                                                             |
| -- | ------------------------------------------------------------------------------ |
| 認証 | Argon2id + JWT (HS256) / 初期パスワード変更強制                                           |
| 配色 | GitHub Dark (Primer Teal) / Light 切替                                           |
| IA | 左サイドバー：**Domains / Devices / Logs / Network / Settings**                       |
| UX | - JSON エディタ (Monaco) とフォーム式の両方を提供<br>- 変更→右上 **Deploy** ボタンで即時反映／Rollback 5 世代 |

---

## 6. ログ & 監視

| ログ種別       | 形式                                                          | 送信                                          |
| ---------- | ----------------------------------------------------------- | ------------------------------------------- |
| Access Log | JSON line<br>{ts,host,path,ip,method,status,bytes,sitename} | ファイルローリング → Telegraf → `endpoint.logserver` |
| System     | journalctl (warning+)                                       | 同上                                          |
| Metrics    | CPU, Mem, Net, Caddy req/s                                  | Telegraf → Influx/Prometheus (任意)           |

*送信失敗時はローカルに最大 100 MB バッファリング*

---

## 7. セキュリティポリシー

1. **最小権限実行**

   * Caddy/Caddyfile は非 root (`setcap cap_net_bind_service=+ep`)
   * UI サーバーも 8443 のみ
2. **自動更新**

   * Unattended‑Upgrades + `caddy upgrade` weekly
3. **バックアップ**

   * `/etc/lpg/` を nightly `rsync` (vlan1 NAS 等)
4. **ポートスキャン防御**

   * nftables `add rule inet filter input tcp flags syn tcp option maxseg size set 1024 ...` 等
5. **WebSocket Hardening**

   * `websocket_timeout` / per‑origin check

---

## 8. 初期デプロイ手順（要点）

```bash
# 1. OS
armbian-install --variant minimal --hostname LPG --ip 192.168.234.2/24

# 2. Caddy
curl -sfL https://get.caddyserver.com | bash -s personal hook.service
systemctl enable --now caddy

# 3. LPG サービス
git clone https://github.com/yourorg/lacis-proxy-gateway.git
cd lacis-proxy-gateway && ./install.sh   # systemd unit, schema, UI build

# 4. nftables ルール
cp misc/vlan-firewall.nft /etc/nftables.conf && systemctl enable --now nftables
```

---

## 9. 拡張／今後の課題

| 可能な拡張                       | 概要                                         |
| --------------------------- | ------------------------------------------ |
| **Let's Encrypt DNS‑01** 対応 | DDNS でも証明書自動発行を安定化                         |
| **Zero Trust 認証**           | Cloudflare Access / Authelia フロントで二要素      |
| **HA 構成**                   | Keepalived + static ARP による Active‑Standby |
| **UI i18n**                 | Primer の ThemeProvider による日‑英自動切替          |
| **Config バックアップ**           | UI からワンクリックで JSON DL / Restore             |

---

## 10. 想定 FAQ と対策

| Q                           | A                                                  |
| --------------------------- | -------------------------------------------------- |
| DDNS が変わったら？                | Caddy の On‑Demand TLS + Cloudflare トンネル併用で自動追従     |
| 新デバイス追加手順は？                 | UI → **Devices** → *Add Rule* → Deploy（Hot Reload） |
| vlan1 の SSH サーバーに誤って公開されない？ | hostdomains に無い Host は 444 Reset、パスも 404 で遮断       |

---

### まとめ

* **ドメイン識別と振り分け**は Caddy JSON API で完結し、負荷は極小。
* **設定は 1 ファイル運用**に統一し、ホットリロード・世代管理で将来の拡張に備える。
* VLAN ポリシーで **内部資産を段階分離**しつつ、ログを外部 Endpoint に送信して可観測性を確保。

これにより、Orange Pi Zero 3 1 台で **安全・軽量・拡張容易**なリバースプロキシゲートウェイを実現できます。
