# LPG修正実装仕様書

**作成日**: 2025年8月3日  
**バージョン**: 1.0.0  
**作成者**: Claude Code Analysis  

---

## 1. 現在の実装状況の把握

### 1.1 現在の技術スタック

#### バックエンド
- **Go API**: `/Volumes/crucial_MX500/lacis_project/project/LPG/src/api/`
  - フレームワーク: Gin (Go)
  - 認証: JWT
  - 設定管理: JSON ファイルベース
  - プロキシ: Caddy を使用

#### フロントエンド
- **React SPA**: `/Volumes/crucial_MX500/lacis_project/project/LPG/src/web/`
  - TypeScript + React
  - UI: Primer Design System (@primer/react)
  - ルーティング: React Router
  - 状態管理: Context API

#### インフラストラクチャ
- **Caddy**: リバースプロキシ
- **Docker Compose**: 開発環境
- **systemd**: 本番サービス管理

### 1.2 現在のサービス構成

```yaml
# docker-compose.yml より
services:
  caddy:    # ポート 80, 443, 2019
  api:      # ポート 8443 (Go API)
  web:      # ポート 5173 (React開発サーバー)
```

### 1.3 現在のネットワーク構成

```
外部 → ER605 → LPG(192.168.234.2:80) → Orange Pi 5 Plus(192.168.234.10:8080)
     ↓
akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards
```

---

## 2. 特定された問題点

### 2.1 nginx設定の複雑さ（Phase1デバッグ報告より）

#### 問題のあるキャッシュ設定
```nginx
# 現在の問題設定
location /lacisstack/boards/ {
    proxy_cache_valid 200 1h;  # 1時間キャッシュ → 古いファイル配信
    proxy_cache_valid 404 10m;
    add_header X-Cache-Status $upstream_cache_status;
}
```

#### 過度なセキュリティヘッダー
```nginx
# 各サービスで設定すべき項目をLPGで実装
add_header X-Frame-Options SAMEORIGIN;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Strict-Transport-Security "max-age=63072000";
```

### 2.2 WebUIの問題

#### DeployChangeボタンの重なり問題
- base.htmlで `position: fixed; top: 12px; right: 24px;` 
- React版Layoutコンポーネントで重複実装
- ヘッダーレイアウトとの競合

#### 二重実装の状況
```
Flask Templates (src/templates/) + React SPA (src/web/)
  ↓
どちらが実際に使用されているか不明確
```

### 2.3 ネットワーク構成の混在

#### HTTPSアクセス問題
- ブラウザ: `https://akb001yebraxfqsm9y.dyndns-web.com`
- LPG: HTTP:80のみ対応
- 結果: 404 Not Found

#### ポートフォワーディング不明確
- ポート80: 設定済み？
- ポート443: 未設定？

---

## 3. 修正方針

### 3.1 LPGの役割を単純化

#### するべきこと
1. **DDNSドメイン/パスの変換**
   - `akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards` → `192.168.234.10:8080`
   - パスベースのルーティングのみ

2. **トラフィックのスルー転送**
   - セキュリティは各サービス側で実装
   - 透過的なプロキシとして機能

#### やめるべきこと
- キャッシュ機構
- 過度なセキュリティヘッダー
- 認証処理への介入

### 3.2 技術スタックの統一

#### 推奨: Caddy + Go API + React SPA
- **Caddy**: 単純なリバースプロキシ設定
- **Go API**: 設定管理とWebUI API
- **React**: 管理インターフェース

#### 廃止すべき技術
- Flask Templates（src/templates/）
- nginx（Caddyに統一）
- 複雑なキャッシュ設定

---

## 4. 詳細修正仕様

### 4.1 Caddy設定の単純化

#### 修正前（問題あり）
```caddy
# 複雑なセキュリティヘッダー、キャッシュ、認証設定
(security_headers) {
    header {
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'..."
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=()"
        -Server
    }
}
```

#### 修正後（推奨）
```caddy
# Caddyfile - シンプル版
{
    admin localhost:2019
    log {
        output file /var/log/lpg/caddy.log
        format json
        level INFO
    }
}

# HTTPからHTTPSへのリダイレクト
:80 {
    redir https://{host}{uri} permanent
}

# メインのHTTPS設定
https://akb001yebraxfqsm9y.dyndns-web.com {
    # TLS設定
    tls {
        protocols tls1.2 tls1.3
    }
    
    # LacisDrawBoards - シンプルなリバースプロキシ
    handle /lacisstack/boards* {
        uri strip_prefix /lacisstack/boards
        
        reverse_proxy 192.168.234.10:8080 {
            # 基本的なヘッダーのみ
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Prefix /lacisstack/boards
        }
    }
    
    # 将来の拡張用
    handle /lacisstack/api* {
        uri strip_prefix /lacisstack/api
        reverse_proxy 192.168.234.11:3000
    }
    
    # デフォルトレスポンス
    handle {
        respond "LacisProxyGateway" 200
    }
    
    # アクセスログ
    log {
        output file /var/log/lpg/access.log
        format json
    }
}

# 管理UI用のローカルアクセス
:8443 {
    reverse_proxy localhost:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    log {
        output file /var/log/lpg/admin-access.log
        format json
    }
}
```

### 4.2 WebUI改修仕様

#### 現在の問題の解決
1. **Flask Templates削除**
   - `/src/templates/` ディレクトリを削除
   - React SPAに統一

2. **DeployButtonの統一**
   ```typescript
   // components/DeployButton.tsx
   interface DeployButtonProps {
     onDeploy: () => Promise<void>
     className?: string
   }

   const DeployButton: React.FC<DeployButtonProps> = ({ onDeploy, className }) => {
     const [isDeploying, setIsDeploying] = useState(false)
     
     const handleDeploy = async () => {
       if (!window.confirm('設定を適用しますか？')) return
       
       setIsDeploying(true)
       try {
         await onDeploy()
         toast.success('設定が適用されました')
       } catch (error) {
         toast.error('デプロイに失敗しました')
       } finally {
         setIsDeploying(false)
       }
     }

     return (
       <Button
         variant="primary"
         onClick={handleDeploy}
         disabled={isDeploying}
         className={className}
       >
         {isDeploying ? 'デプロイ中...' : 'Deploy Changes'}
       </Button>
     )
   }
   ```

3. **Layout修正**
   ```typescript
   // components/Layout.tsx - ヘッダーにDeployButton統合
   const Layout: React.FC = () => {
     const { deployConfig } = useConfig()
     
     return (
       <Box height="100vh" display="flex" flexDirection="column">
         <StyledHeader>
           <Header.Item>
             <Logo>
               <Octicon icon={HomeIcon} size={24} />
               <span>LacisProxyGateway</span>
             </Logo>
           </Header.Item>

           <Header.Item>
             <Box display="flex" alignItems="center" gap={2}>
               <DeployButton onDeploy={deployConfig} />
               <IconButton icon={isDarkMode ? SunIcon : MoonIcon} />
               <UserMenu />
             </Box>
           </Header.Item>
         </StyledHeader>
         {/* ... */}
       </Box>
     )
   }
   ```

#### 新機能: トポロジービュー

```typescript
// pages/TopologyPage.tsx - 新規追加
interface NetworkNode {
  id: string
  label: string
  type: 'gateway' | 'proxy' | 'service'
  ip: string
  port?: number
  status: 'online' | 'offline' | 'unknown'
}

interface NetworkEdge {
  id: string
  source: string
  target: string
  label?: string
  protocol: 'http' | 'https' | 'tcp'
}

const TopologyPage: React.FC = () => {
  const [nodes, setNodes] = useState<NetworkNode[]>([])
  const [edges, setEdges] = useState<NetworkEdge[]>([])
  
  // ネットワーク構成を可視化
  const renderTopology = () => {
    return (
      <Box p={4}>
        <Heading as="h1" sx={{ mb: 4 }}>
          ネットワークトポロジー
        </Heading>
        
        <TopologyDiagram nodes={nodes} edges={edges} />
        
        <Box mt={4}>
          <Heading as="h2" sx={{ fontSize: 3, mb: 3 }}>
            サービス一覧
          </Heading>
          <ServiceStatusTable nodes={nodes} />
        </Box>
      </Box>
    )
  }
  
  return renderTopology()
}
```

### 4.3 Go API修正

#### 設定管理の改善
```go
// models/config.go - 設定構造体の明確化
type Config struct {
    Version     string                 `json:"version"`
    LastUpdated time.Time             `json:"lastUpdated"`
    HostDomains map[string]string     `json:"hostdomains"`     // domain -> subnet
    Routes      map[string]DomainRoutes `json:"hostingdevice"`   // domain -> routes
}

type DomainRoutes map[string]Route  // path -> route

type Route struct {
    DeviceIP string   `json:"deviceip"`
    Port     []int    `json:"port"`
    SiteName string   `json:"sitename"`
    IPs      []string `json:"ips"`
}
```

#### Caddyクライアントの改善
```go
// services/caddy_client.go - 設定反映の自動化
func (c *CaddyClient) DeployConfig(config *Config) error {
    // 1. Caddyfileの生成
    caddyfile, err := c.generateCaddyfile(config)
    if err != nil {
        return err
    }
    
    // 2. 設定の検証
    if err := c.validateConfig(caddyfile); err != nil {
        return err
    }
    
    // 3. 設定の適用
    return c.reloadConfig(caddyfile)
}

func (c *CaddyClient) generateCaddyfile(config *Config) (string, error) {
    var buf bytes.Buffer
    
    // グローバル設定
    buf.WriteString("{\n")
    buf.WriteString("    admin localhost:2019\n")
    buf.WriteString("}\n\n")
    
    // HTTPSリダイレクト
    buf.WriteString(":80 {\n")
    buf.WriteString("    redir https://{host}{uri} permanent\n")
    buf.WriteString("}\n\n")
    
    // 各ドメインの処理
    for domain, routes := range config.Routes {
        buf.WriteString(fmt.Sprintf("https://%s {\n", domain))
        
        for path, route := range routes {
            if route.DeviceIP == "" {
                continue // 空のルートはスキップ
            }
            
            buf.WriteString(fmt.Sprintf("    handle %s* {\n", path))
            buf.WriteString(fmt.Sprintf("        uri strip_prefix %s\n", path))
            buf.WriteString(fmt.Sprintf("        reverse_proxy %s:%d\n", 
                route.DeviceIP, route.Port[0]))
            buf.WriteString("    }\n\n")
        }
        
        buf.WriteString("}\n\n")
    }
    
    return buf.String(), nil
}
```

---

## 5. 実装手順

### 5.1 Phase 1: 設定の単純化（緊急）

#### 5.1.1 Caddy設定の修正
```bash
# 1. 現在の設定をバックアップ
sudo cp /etc/caddy/Caddyfile /etc/caddy/Caddyfile.backup.$(date +%Y%m%d)

# 2. 新しいシンプル設定を適用
sudo nano /etc/caddy/Caddyfile

# 3. 設定テストと適用
sudo caddy validate --config /etc/caddy/Caddyfile
sudo systemctl reload caddy
```

#### 5.1.2 キャッシュクリア
```bash
# Caddyキャッシュのクリア（もしあれば）
sudo rm -rf /var/cache/caddy/*

# ブラウザキャッシュクリア指示
# Ctrl+Shift+R でハードリロード
```

### 5.2 Phase 2: WebUI統一（1週間）

#### 5.2.1 Flask Templates削除
```bash
# src/templates/ ディレクトリを削除
rm -rf /Volumes/crucial_MX500/lacis_project/project/LPG/src/templates/

# Flask関連のPythonファイル削除
rm /Volumes/crucial_MX500/lacis_project/project/LPG/src/lpg_*.py
```

#### 5.2.2 React SPA完全移行
1. **DeployButton統一**
2. **Layout修正**
3. **TopologyPage追加**
4. **ビルドプロセス確立**

### 5.3 Phase 3: ネットワーク構成明確化（2日）

#### 5.3.1 ポートフォワーディング確認
```
ER605 Omada設定:
- 外部ポート80 → 192.168.234.2:80 ✓
- 外部ポート443 → 192.168.234.2:443 ✓
```

#### 5.3.2 HTTPS証明書設定
```bash
# Let's Encrypt証明書の自動取得（Caddyが自動実行）
# 手動での確認方法
curl -v https://akb001yebraxfqsm9y.dyndns-web.com/
```

---

## 6. 新しいWebUI仕様

### 6.1 ページ構成

#### 既存ページの改善
1. **Domains** - ドメイン管理
2. **Devices** - ルーティングルール管理  
3. **Logs** - アクセスログビューアー
4. **Network** - システムメトリクス
5. **Settings** - 設定管理

#### 新規追加ページ
6. **Topology** - ネットワークトポロジー可視化

### 6.2 Topologyページ詳細仕様

#### 6.2.1 表示内容
```
┌─────────────────────────────────────────────────────────┐
│ ネットワークトポロジー                                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [Internet]                                             │
│      ↓                                                  │
│  [ER605 Router]                                         │
│      ↓                                                  │
│  [LPG Proxy: 192.168.234.2]                           │
│      ├─→ [Orange Pi 5+: 192.168.234.10:8080] (DrawBoards) │
│      └─→ [Future Service: 192.168.234.11:3000] (API)   │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ Service Status                                          │
│ ┌─────────────┬──────────┬─────────┬──────────────────┐ │
│ │ Service     │ Status   │ Latency │ Last Check       │ │
│ ├─────────────┼──────────┼─────────┼──────────────────┤ │
│ │ LPG Proxy   │ ●Online  │ 1ms     │ 2025-08-03 15:30 │ │
│ │ DrawBoards  │ ●Online  │ 15ms    │ 2025-08-03 15:30 │ │
│ │ Future API  │ ○Offline │ -       │ -                │ │
│ └─────────────┴──────────┴─────────┴──────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### 6.2.2 機能
1. **リアルタイム監視**
   - 各サービスの生存確認
   - レスポンス時間測定
   - ステータス更新（10秒間隔）

2. **接続テスト**
   - 手動での接続確認
   - トレースルート表示
   - ポート開放確認

3. **ログ連携**
   - トポロジーからログページへの遷移
   - サービス固有のログフィルタ

### 6.3 UI/UXの改善

#### 6.3.1 共通レイアウト
```typescript
// 固定ヘッダーの高さ調整
const HEADER_HEIGHT = '64px'
const DEPLOY_BUTTON_HEIGHT = '40px'

const StyledHeader = styled(Header)`
  height: ${HEADER_HEIGHT};
  padding: 0 16px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  background: var(--color-canvas-subtle);
  border-bottom: 1px solid var(--color-border-default);
`

const MainContent = styled(Box)`
  margin-top: ${HEADER_HEIGHT};
  height: calc(100vh - ${HEADER_HEIGHT});
  overflow-y: auto;
`
```

#### 6.3.2 レスポンシブ対応
```typescript
const useBreakpoint = () => {
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768)
  
  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768)
    window.addEventListener('resize', handleResize)
    return () => window.removeEventListener('resize', handleResize)
  }, [])
  
  return { isMobile }
}
```

---

## 7. セキュリティ要件の見直し

### 7.1 LPG側では実装しない

#### 削除すべきセキュリティヘッダー
- X-Frame-Options
- X-Content-Type-Options  
- X-XSS-Protection
- Content-Security-Policy
- Strict-Transport-Security
- Permissions-Policy

#### 理由
1. **各サービスの責任**
   - LacisDrawBoardsで適切にCSPを設定
   - サービス固有のセキュリティ要件に対応

2. **デバッグの容易さ**
   - 問題の切り分けが明確
   - セキュリティ問題のトラブルシューティングが容易

### 7.2 LPG側で実装するもの

#### 最小限の設定
```caddy
# 基本的なHTTPS設定のみ
tls {
    protocols tls1.2 tls1.3
}

# アクセスログ記録
log {
    output file /var/log/lpg/access.log
    format json
}
```

---

## 8. 運用・監視仕様

### 8.1 ログ管理

#### 8.1.1 Caddyアクセスログ
```json
{
  "ts": 1691027400.123,
  "request": {
    "remote_ip": "203.0.113.1",
    "remote_port": "54321", 
    "client_ip": "203.0.113.1",
    "proto": "HTTP/2.0",
    "method": "GET",
    "host": "akb001yebraxfqsm9y.dyndns-web.com",
    "uri": "/lacisstack/boards/",
    "headers": {
      "User-Agent": ["Mozilla/5.0..."]
    }
  },
  "bytes_read": 0,
  "user_id": "",
  "duration": 0.035,
  "size": 1234,
  "status": 200,
  "resp_headers": {
    "Content-Type": ["text/html"]
  }
}
```

#### 8.1.2 Go APIログ
```json
{
  "time": "2025-08-03T15:30:45+09:00",
  "level": "info",
  "msg": "Config deployed successfully",
  "user": "admin",
  "config_version": "1.2.3",
  "changes": ["added route /lacisstack/boards"]
}
```

### 8.2 監視指標

#### 8.2.1 Caddyメトリクス
- リクエスト数/秒
- レスポンス時間
- エラー率
- アップストリームの可用性

#### 8.2.2 システムメトリクス  
- CPU使用率
- メモリ使用率
- ディスク使用率
- ネットワークトラフィック

### 8.3 アラート設定

#### 8.3.1 エラー条件
1. **アップストリーム接続エラー**
   - 5xx エラーが 1分間で 10回以上

2. **システムリソース**
   - CPU使用率 90% 以上が 5分継続
   - メモリ使用率 95% 以上

3. **ネットワーク**
   - 外部ドメインアクセス不可

---

## 9. 移行・テスト計画

### 9.1 移行手順

#### 9.1.1 事前準備
```bash
# 1. 現在の設定をバックアップ
sudo tar -czf /opt/lpg-backup-$(date +%Y%m%d).tar.gz \
  /etc/caddy/Caddyfile \
  /etc/lpg/config.json \
  /opt/lpg/src/

# 2. 開発環境での事前テスト
cd /Volumes/crucial_MX500/lacis_project/project/LPG
docker-compose up -d
curl -v http://localhost/lacisstack/boards/
```

#### 9.1.2 本番適用
```bash
# 1. 新しいCaddyfile適用
sudo cp Caddyfile.new /etc/caddy/Caddyfile
sudo caddy validate --config /etc/caddy/Caddyfile
sudo systemctl reload caddy

# 2. Go APIの更新
sudo systemctl stop lpg
sudo cp -r src/api/* /opt/lpg/src/api/
sudo systemctl start lpg

# 3. React SPAのビルド・デプロイ
npm run build
sudo cp -r dist/* /var/www/lpg/
```

### 9.2 テストケース

#### 9.2.1 機能テスト
1. **プロキシ機能**
   ```bash
   # 外部アクセス
   curl -v https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards/
   
   # 内部アクセス
   curl -v http://192.168.234.2/lacisstack/boards/
   
   # 管理UI
   curl -v http://192.168.234.2:8443/
   ```

2. **WebUI機能**
   - ログイン/ログアウト
   - ドメイン追加/削除
   - ルート設定変更
   - 設定デプロイ
   - トポロジー表示

#### 9.2.2 性能テスト
```bash
# 負荷テスト
ab -n 1000 -c 10 https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards/

# レスポンス時間測定
curl -w "@curl-format.txt" -o /dev/null -s https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards/
```

### 9.3 ロールバック手順

```bash
# 問題発生時の緊急ロールバック
sudo cp /etc/caddy/Caddyfile.backup.20250803 /etc/caddy/Caddyfile
sudo systemctl reload caddy

# 完全ロールバック
sudo systemctl stop lpg
sudo tar -xzf /opt/lpg-backup-20250803.tar.gz -C /
sudo systemctl start lpg
```

---

## 10. 予想される課題と対策

### 10.1 技術的課題

#### 10.1.1 HTTPS証明書の自動更新
**課題**: Let's Encrypt証明書の90日期限
**対策**: Caddyの自動更新機能を活用
```caddy
# Caddyが自動的に証明書を取得・更新
# 設定ファイルにドメイン名を記載するだけ
https://akb001yebraxfqsm9y.dyndns-web.com {
    # 自動的にLet's Encryptから証明書取得
}
```

#### 10.1.2 静的ファイルキャッシュ問題
**課題**: ブラウザキャッシュによる古いファイル配信
**対策**: ファイル名にハッシュを含める（Viteが自動実行）
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        entryFileNames: 'assets/[name]-[hash].js',
        chunkFileNames: 'assets/[name]-[hash].js',
        assetFileNames: 'assets/[name]-[hash].[ext]'
      }
    }
  }
})
```

### 10.2 運用課題

#### 10.2.1 Orange Pi 5 Plusへのアクセス
**課題**: SSH接続不可、物理アクセス必要
**対策**: 
1. 物理コンソールでの初期設定
2. SSH鍵の再設定
3. 固定IPの確認

#### 10.2.2 ネットワーク設定の変更影響
**課題**: ER605設定変更時の影響
**対策**:
1. 設定変更前のバックアップ
2. 段階的な変更適用
3. ロールバック手順の文書化

---

## 11. 完了基準

### 11.1 Phase 1完了基準（緊急対応）

- [ ] Caddyfile設定を単純化
- [ ] キャッシュ問題の解決確認
- [ ] `https://akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards/` の正常アクセス
- [ ] 最新のJavaScriptファイルが正しく配信される

### 11.2 Phase 2完了基準（WebUI統一）

- [ ] Flask Templates完全削除
- [ ] React SPA単一化
- [ ] DeployButtonの重なり問題解決
- [ ] Topologyページの実装
- [ ] 全機能の動作確認

### 11.3 Phase 3完了基準（システム安定化）

- [ ] HTTPS証明書の自動取得・更新
- [ ] アクセスログの正常記録
- [ ] 監視・アラート機能
- [ ] 運用ドキュメント整備
- [ ] 性能テスト完了

---

## 12. 今後の拡張性

### 12.1 新サービス追加の容易さ

#### 12.1.1 設定追加例
```json
// config.json
{
  "hostingdevice": {
    "akb001yebraxfqsm9y.dyndns-web.com": {
      "/lacisstack/boards": {
        "deviceip": "192.168.234.10",
        "port": [8080],
        "sitename": "whiteboard",
        "ips": ["any"]
      },
      "/lacisstack/chat": {
        "deviceip": "192.168.234.12", 
        "port": [3000],
        "sitename": "chat",
        "ips": ["any"]
      }
    }
  }
}
```

#### 12.1.2 Caddyfile自動生成
```go
// 新しいサービスが追加されると自動的にCaddyfileに反映
func (c *CaddyClient) generateCaddyfile(config *Config) string {
    // 設定からCaddyfileを動的生成
    // 手動でのnginx設定変更不要
}
```

### 12.2 将来の機能拡張

#### 12.2.1 負荷分散
```caddy
# 複数インスタンスへの負荷分散
handle /lacisstack/boards* {
    reverse_proxy {
        to 192.168.234.10:8080
        to 192.168.234.13:8080
        lb_policy round_robin
        health_uri /health
    }
}
```

#### 12.2.2 WebSocket対応
```caddy
# WebSocket接続の自動検出・転送
@websockets {
    header Connection *Upgrade*
    header Upgrade websocket
}
reverse_proxy @websockets 192.168.234.10:8081
```

---

## 付録A: 設定ファイルテンプレート

### A.1 新しいCaddyfile

```caddy
# /etc/caddy/Caddyfile - 修正版
{
    admin localhost:2019
    log {
        output file /var/log/lpg/caddy.log
        format json
        level INFO
    }
}

# HTTPからHTTPSへのリダイレクト
:80 {
    redir https://{host}{uri} permanent
}

# メインのHTTPS設定
https://akb001yebraxfqsm9y.dyndns-web.com {
    # TLS設定（Let's Encrypt自動取得）
    tls {
        protocols tls1.2 tls1.3
    }
    
    # LacisDrawBoards
    handle /lacisstack/boards* {
        uri strip_prefix /lacisstack/boards
        
        reverse_proxy 192.168.234.10:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Prefix /lacisstack/boards
        }
    }
    
    # デフォルトレスポンス
    handle {
        respond "LacisProxyGateway - akb001yebraxfqsm9y.dyndns-web.com" 200
    }
    
    # アクセスログ
    log {
        output file /var/log/lpg/access.log
        format json
    }
}

# 管理UI用（ローカルアクセスのみ）
:8443 {
    reverse_proxy localhost:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    log {
        output file /var/log/lpg/admin-access.log
        format json
    }
}
```

### A.2 Docker Compose設定

```yaml
# docker-compose.yml - 本番用
version: '3.8'

services:
  # Caddy リバースプロキシ
  caddy:
    image: caddy:2.8-alpine
    container_name: lpg-caddy
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - ./logs:/var/log/lpg
    environment:
      - CADDY_ADMIN=0.0.0.0:2019
    networks:
      - lpg-network
    restart: unless-stopped

  # LPG API サーバー
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lpg-api
    ports:
      - "8080:8080"
    volumes:
      - ./config:/etc/lpg
      - ./logs:/var/log/lpg
    environment:
      - ENVIRONMENT=production
      - PORT=8080
      - CONFIG_PATH=/etc/lpg/config.json
      - JWT_SECRET=${JWT_SECRET}
      - CADDY_ADMIN_API=http://caddy:2019
    depends_on:
      - caddy
    networks:
      - lpg-network
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:

networks:
  lpg-network:
    driver: bridge
```

---

**この仕様書は、LPGの現在の問題を解決し、将来の拡張性を確保するための包括的な修正計画です。特に緊急性の高いキャッシュ問題とWebUIの重複問題から着手することを強く推奨します。**