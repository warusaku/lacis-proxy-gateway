---
title: LacisProxyGateway セットアップ手順書
projects:
- LPG
tags:
- '#proj-lpg'
created: '2025-07-28'
updated: '2025-07-28'
author: unknown
status: draft
---
# LacisProxyGateway セットアップ手順書

**Version: 2.0.0**  
**更新日: 2025-01-12**

---

## 目次

1. [前提条件と準備](#1-前提条件と準備)
2. [Omadaクラウドコントローラー設定](#2-omadaクラウドコントローラー設定)
3. [Orange Pi Zero 3の初期セットアップ](#3-orange-pi-zero-3の初期セットアップ)
4. [SSH経由での初期設定](#4-ssh経由での初期設定)
5. [FTP経由でのデプロイメント](#5-ftp経由でのデプロイメント)
6. [接続テスト環境のセットアップ](#6-接続テスト環境のセットアップ)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. 前提条件と準備

### 1.1 必要な機器とソフトウェア

#### ハードウェア
- **Omada対応機器**
  - ゲートウェイ: ER605 または同等品
  - スイッチ: TL-SG2008 または VLAN対応スイッチ
  - コントローラー: OC300 または Omadaクラウド
- **Orange Pi Zero 3**（LPG用）
  - RAM: 4GB推奨
  - microSDカード: 16GB以上（Class 10/UHS-I）
  - 電源: 5V 3A USB-C電源アダプター
- **Orange Pi Zero 3**（テスト用）※オプション
  - 同上のスペック

#### ソフトウェア・ツール
- **PC側ツール**
  - SSH クライアント（PuTTY、Terminal等）
  - FTP クライアント（FileZilla推奨）
  - SDカード書き込みツール（balenaEtcher等）
  - テキストエディタ（VSCode等）
- **ダウンロードするもの**
  - Armbian イメージ（Orange Pi Zero 3用）
  - LPGソースコード

### 1.2 ネットワーク設計

```
[インターネット]
    │
    ├─ [OmadaゲートウェイER605]
    │   │ WAN: DHCPまたは固定IP
    │   │ LAN: 192.168.3.1/24
    │   │
    │   ├─ [VLAN1: 管理ネットワーク]
    │   │   └─ 192.168.3.0/24
    │   │       └─ 管理PC: 192.168.3.100
    │   │
    │   └─ [VLAN555: LPG専用ネットワーク]
    │       └─ 192.168.234.0/24
    │           ├─ LPG (Orange Pi Zero 3): 192.168.234.2
    │           └─ テストサーバー (Orange Pi Zero 3): 192.168.234.10
```

### 1.3 作業前チェックリスト

- [ ] Omadaクラウドアカウントの作成完了
- [ ] ER605がOmadaクラウドに登録済み
- [ ] スイッチがVLAN対応で設定可能
- [ ] Orange Pi Zero 3が2台準備済み
- [ ] microSDカード（16GB以上）が2枚準備済み
- [ ] 管理PCがネットワークに接続済み

---

## 2. Omadaクラウドコントローラー設定

### 2.1 Omadaクラウドへのログイン

1. **ブラウザでアクセス**
   ```
   URL: https://omada.tplinkcloud.com
   ```

2. **ログイン情報入力**
   - Email/TP-Link ID
   - パスワード
   - 2段階認証（設定している場合）

3. **サイトの選択**
   - 複数サイトがある場合は、対象のサイトを選択

### 2.2 VLAN設定（詳細版）

#### VLAN555の作成

1. **設定画面へ移動**
   ```
   Settings → Wired Networks → LAN
   ```

2. **新規LANネットワーク作成**
   ```
   [+ Create New LAN] ボタンをクリック
   ```

3. **詳細設定入力**
   ```yaml
   基本設定:
     Name: lacisstack
     Purpose: Corporate  # または Custom
     Network/VLAN:
       VLAN: Enable
       VLAN ID: 555
   
   ゲートウェイ設定:
     Gateway/Subnet: 192.168.234.1/24
     
   DHCP設定:
     DHCP Mode: DHCP Server
     DHCP Range: 192.168.234.100 - 192.168.234.200
     Lease Time: 120 (minutes)
   
   DNS設定:
     Primary DNS: 8.8.8.8
     Secondary DNS: 8.8.4.4
   ```

4. **適用**
   - [Apply] ボタンをクリック
   - 設定が反映されるまで1-2分待機

#### DHCP予約設定（LPG用固定IP）

1. **DHCP予約画面へ**
   ```
   Settings → Wired Networks → LAN → lacisstack → DHCP Reservation
   ```

2. **LPG用の予約追加**
   ```yaml
   [+ Add Reservation]
   
   設定内容:
     MAC Address: [後でOrange Pi起動後に確認]
     IP Address: 192.168.234.2
     Description: LacisProxyGateway
   ```

3. **テストサーバー用の予約追加**
   ```yaml
   [+ Add Reservation]
   
   設定内容:
     MAC Address: [後でOrange Pi起動後に確認]
     IP Address: 192.168.234.10
     Description: Test-Server
   ```

### 2.3 スイッチポートの設定

1. **スイッチ設定画面へ**
   ```
   Devices → Switches → [対象スイッチ] → Ports
   ```

2. **LPG接続用ポート設定**
   ```yaml
   Port 1設定（例）:
     Name: LPG-Port
     Profile: Custom
     Native Network: lacisstack (VLAN555)
     Tagged Networks: None
     PoE: Disabled（Orange Piは非対応）
   ```

3. **テストサーバー接続用ポート設定**
   ```yaml
   Port 2設定（例）:
     Name: Test-Server-Port
     Profile: Custom
     Native Network: lacisstack (VLAN555)
     Tagged Networks: None
   ```

### 2.4 ACL（アクセス制御リスト）の詳細設定

#### 基本的なセキュリティルール

1. **ACL画面へ移動**
   ```
   Settings → Firewall → ACL → Gateway ACL
   ```

2. **ルール1: VLAN555から他VLANへの通信を遮断**
   ```yaml
   [+ Add Rule]
   
   General:
     Name: Block VLAN555 Outbound
     Status: Enable
   
   Policy:
     Action: Deny
   
   Source:
     Type: Network
     Network: lacisstack
   
   Destination:
     Type: Network
     Network: LAN (VLAN1)
   
   Protocol:
     Protocol: All
   ```

3. **ルール2: VLAN1からLPG管理機能へのアクセス許可**
   ```yaml
   [+ Add Rule]
   
   General:
     Name: Allow VLAN1 Admin Access to LPG
     Status: Enable
   
   Policy:
     Action: Permit
   
   Source:
     Type: Network
     Network: LAN  # VLAN1全体
   
   Destination:
     Type: IP Port Group
     IP Group: 192.168.234.2
     Port Group: 8443,22,21,30000-30100
   
   Protocol:
     Protocol: TCP
   ```

4. **ルール3: VLAN1からLPGのHTTP/HTTPSへのアクセス許可**
   ```yaml
   [+ Add Rule]
   
   General:
     Name: Allow HTTP/HTTPS to LPG
     Status: Enable
   
   Policy:
     Action: Permit
   
   Source:
     Type: Network
     Network: LAN
   
   Destination:
     Type: IP Port Group
     IP Group: 192.168.234.2
     Port Group: 80,443
   
   Protocol:
     Protocol: TCP
   ```

5. **ルール4: インターネットからVLAN555への通信を遮断**
   ```yaml
   [+ Add Rule]
   
   General:
     Name: Block Internet to VLAN555
     Status: Enable
   
   Policy:
     Action: Deny
   
   Source:
     Type: IP Group
     Content: 0.0.0.0/0
   
   Destination:
     Type: Network
     Network: lacisstack
   
   Protocol:
     Protocol: All
   ```

#### ポートフォワーディング設定

1. **NAT設定画面へ**
   ```
   Settings → Transmission → NAT → Port Forwarding
   ```

2. **HTTP転送ルール**
   ```yaml
   [+ Add Rule]
   
   設定内容:
     Name: LPG-HTTP
     External Ports: 80
     Forward To:
       Device: Custom
       Internal IP: 192.168.234.2
       Internal Ports: 80
     Protocol: TCP
     Status: Enable
   ```

3. **HTTPS転送ルール**
   ```yaml
   [+ Add Rule]
   
   設定内容:
     Name: LPG-HTTPS
     External Ports: 443
     Forward To:
       Device: Custom
       Internal IP: 192.168.234.2
       Internal Ports: 443
     Protocol: TCP
     Status: Enable
   ```

### 2.5 Omada設定の確認とバックアップ

1. **設定の確認**
   - Dashboard → Logsで設定変更が正常に適用されたか確認
   - エラーがないことを確認

2. **設定のバックアップ**
   ```
   Settings → Maintenance → Backup & Restore
   → [Backup] ボタンをクリック
   → バックアップファイルをダウンロード
   ```

---

## 3. Orange Pi Zero 3の初期セットアップ

> **重要**: この章では、Orange Pi Zero 3（小型コンピュータ）に最初のOSをインストールします。  
> 最初の設定のみモニターとキーボードを使用し、その後はすべてSSH（リモート接続）で作業します。

### 3.1 必要な機材の確認

#### 初回セットアップに必要なもの
- [ ] Orange Pi Zero 3本体
- [ ] microSDカード（16GB以上）※新品または完全にフォーマット済み
- [ ] SDカードリーダー（PCに接続用）
- [ ] microHDMIケーブル（Orange Pi → モニター接続用）
- [ ] HDMIモニターまたはテレビ
- [ ] USBキーボード（マウスは不要）
- [ ] USB-C電源アダプター（5V 3A）※スマホの充電器では電力不足の場合あり
- [ ] LANケーブル（ネットワーク接続用）

#### 用語説明
- **SBC**: シングルボードコンピュータの略。Orange Piのような小型PC
- **Armbian**: Orange Pi用のLinux OS（オペレーティングシステム）
- **SSH**: ネットワーク経由でコンピュータを遠隔操作する方法
- **IPアドレス**: ネットワーク上のコンピュータの住所のようなもの

### 3.2 ArmbianイメージのダウンロードとSDカード作成

#### ステップ1: Armbianイメージのダウンロード

1. **作業PCでブラウザを開く**
   - URL: https://www.armbian.com/orangepizero3/
   - 「Armbian Jammy」を探してダウンロード
   - ファイル名例: `Armbian_24.5.0_Orangepizero3_jammy_current_6.6.31.img.xz`
   - サイズ: 約400MB（ダウンロードに5-10分程度）

2. **ダウンロードしたファイルを解凍**
   - Windows: 7-Zipをインストールし、右クリック→「7-Zip」→「ここに展開」
   - Mac: ダブルクリックで自動解凍
   - 解凍後のファイル名: `Armbian_24.5.0_Orangepizero3_jammy_current_6.6.31.img`

#### ステップ2: SDカードへの書き込み

> **注意**: この作業でSDカードの内容はすべて消去されます。必要なデータは事前にバックアップしてください。

##### Windows（balenaEtcher使用）- 推奨

1. **balenaEtcherのインストール**
   - https://www.balena.io/etcher/ からダウンロード
   - インストーラーを実行してインストール

2. **SDカードの書き込み**
   ```
   手順:
   1. SDカードをPCに挿入
   2. balenaEtcherを起動
   3. 「Flash from file」をクリック → Armbianイメージファイルを選択
   4. 「Select target」をクリック → SDカードを選択（通常は自動認識）
   5. 「Flash!」をクリック
   6. 完了まで待つ（5-10分程度）
   7. 「Flash Complete!」と表示されたら成功
   ```

##### macOSの場合

1. **ターミナルを開く**
   - Finder → アプリケーション → ユーティリティ → ターミナル

2. **SDカードの確認と書き込み**
   ```bash
   # SDカードを挿入してから実行
   diskutil list
   
   # 出力例:
   # /dev/disk4 (external, physical):
   #    #:                       TYPE NAME        SIZE       IDENTIFIER
   #    0:     FDisk_partition_scheme             15.9 GB    disk4
   
   # disk4がSDカードの場合（サイズで確認）
   diskutil unmountDisk /dev/disk4
   
   # 書き込み（disk4の部分は環境により異なる）
   sudo dd if=Armbian_24.5.0_Orangepizero3_jammy_current_6.6.31.img of=/dev/rdisk4 bs=4m
   
   # パスワードを求められたらMacのパスワードを入力
   # 進捗は表示されないので、完了まで待つ（5-10分）
   
   # 完了したら取り出し
   diskutil eject /dev/disk4
   ```

### 3.3 Orange Pi Zero 3の初回起動

#### ステップ1: 接続作業

1. **SDカードをOrange Piに挿入**
   - Orange Pi Zero 3の裏面にあるmicroSDスロットに挿入
   - カチッと音がするまで押し込む

2. **ケーブル接続（接続順序が重要）**
   ```
   接続順序:
   1. LANケーブルをOrange Piに接続 → スイッチ/ルーターへ
   2. microHDMIケーブルをOrange Piに接続 → モニターへ
   3. USBキーボードをOrange Piに接続
   4. モニターの電源を入れ、HDMI入力に切り替え
   5. 最後にUSB-C電源を接続（これで自動的に起動）
   ```

#### ステップ2: 初回ログインと設定

> **画面の見方**: 黒い画面に白い文字が流れていきます。これは正常です。

1. **起動待機（1-2分）**
   - たくさんの文字が流れた後、ログイン画面が表示される
   - 表示例:
   ```
   Armbian 24.5.0 jammy ttyS0
   
   orangepizero3 login: _
   ```

2. **初回ログイン**
   ```
   操作手順:
   1. login: と表示されたら「root」と入力してEnter
   2. Password: と表示されたら「1234」と入力してEnter
      ※パスワード入力時は画面に文字が表示されません（セキュリティのため）
   ```

3. **初期設定ウィザード（自動的に開始）**
   
   **新しいrootパスワードの設定**
   ```
   画面表示:
   You are required to change your password immediately (root enforced)
   Changing password for root.
   Current password: 
   
   操作:
   1. Current password: で「1234」を入力してEnter
   2. New password: で新しいパスワードを入力してEnter
      推奨: 8文字以上、英数字混合（例: OrangePi2024!）
   3. Retype new password: で同じパスワードを再入力してEnter
   ```

   **一般ユーザーの作成**
   ```
   画面表示:
   Create a new user account:
   Please provide a username:
   
   操作:
   1. 「lacisadmin」と入力してEnter
   
   2. Create password: で「lacis12345@」と入力してEnter
   3. Retype password: で「lacis12345@」と再入力してEnter
   
   4. Please provide your real name: で「LPG Admin」と入力してEnter
   
   5. Set user language based on your location? [Y/n] で「n」と入力してEnter
   ```

   **タイムゾーン設定**
   ```
   画面表示:
   Set time zone:
   1) Africa
   2) America
   3) Antarctica
   4) Arctic
   5) Asia
   ...
   
   操作:
   1. Geographic area: で「5」（Asia）を入力してEnter
   2. 次の画面でTokyoを探す（通常は67番あたり）
   3. Time zone: で「67」を入力してEnter
   ```

4. **IPアドレスの確認（重要！）**
   
   初期設定が完了すると、自動的にコマンド入力画面になります。
   
   ```bash
   # 以下のコマンドを入力
   ip addr show eth0
   ```
   
   表示例：
   ```
   2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
       link/ether aa:bb:cc:dd:ee:ff brd ff:ff:ff:ff:ff:ff
       inet 192.168.234.123/24 brd 192.168.234.255 scope global dynamic noprefixroute eth0
   ```
   
   **メモする内容**:
   - MACアドレス: `aa:bb:cc:dd:ee:ff`の部分
   - IPアドレス: `192.168.234.123`の部分
   
   これらは後でOmada設定とSSH接続で使用します。

### 3.4 SSH接続への切り替え

#### ステップ1: Orange Pi側の準備確認

1. **SSH サービスの確認**
   ```bash
   # Orange Piのキーボードで入力
   systemctl status ssh
   ```
   
   「Active: active (running)」と緑色で表示されればOK

2. **一旦シャットダウン**
   ```bash
   # 安全にシャットダウン
   shutdown -h now
   ```
   
   画面に「Power down」と表示されたら、電源ケーブルを抜く

#### ステップ2: モニター・キーボードの取り外し

1. **ケーブルの取り外し**
   - 電源ケーブルを抜く
   - USBキーボードを取り外す
   - HDMIケーブルを取り外す
   - LANケーブルは接続したまま

2. **最終設置場所への移動**
   - Orange PiをLPG設置予定場所へ移動
   - LANケーブルを接続
   - 電源ケーブルを接続（自動起動）

---

## 4. SSH経由での本格的な設定

> **これ以降の作業**: すべて管理PCからSSH（リモート接続）で行います。

### 4.1 管理PCからのSSH接続

#### Windows（コマンドプロンプト使用）

1. **コマンドプロンプトを開く**
   - Windowsキー + R → 「cmd」と入力 → Enter

2. **SSH接続**
   ```cmd
   ssh lacisadmin@192.168.234.123
   
   ※ 192.168.234.123 は先ほどメモしたIPアドレスに置き換える
   ```

3. **初回接続時の確認**
   ```
   The authenticity of host '192.168.234.123' can't be established.
   ED25519 key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxx.
   Are you sure you want to continue connecting (yes/no/[fingerprint])?
   
   → 「yes」と入力してEnter
   ```

4. **パスワード入力**
   ```
   lacisadmin@192.168.234.123's password: 
   
   → 「lacis12345@」を入力してEnter（表示されません）
   ```

#### macOS/Linux（ターミナル使用）

1. **ターミナルを開く**
   - macOS: Command + Space → 「Terminal」と入力
   - Linux: Ctrl + Alt + T

2. **SSH接続**（Windowsと同じ手順）

#### 接続成功の確認

接続に成功すると以下のような表示になります：
```
Welcome to Armbian 24.5.0 Jammy with Linux 6.6.31-current-sunxi64

System load:   0.15 0.10 0.08   Up time:       5 min
Memory usage:  12% of 3.84G    IP:           192.168.234.123
CPU temp:      42°C           Usage of /:    8% of 15G

lacisadmin@orangepizero3:~$ _
```

### 4.2 Omada DHCP予約の設定

SSH接続ができたら、先ほどメモしたMACアドレスを使ってOmadaで固定IP設定を行います。

1. **Omadaクラウドコントローラーにログイン**
2. **DHCP予約設定**で、MACアドレスと固定IP（192.168.234.2）を設定
3. **Orange Piを再起動**
   ```bash
   sudo reboot
   ```

4. **1分後、新しいIPで再接続**
   ```bash
   # 管理PCから
   ssh lacisadmin@192.168.234.2
   ```

### 4.3 ネットワークの固定IP設定

> **なぜ必要？**: DHCP予約だけでなく、Orange Pi側でも固定IPを設定することで、より確実な接続を保証します。

1. **現在のネットワーク設定を確認**
   ```bash
   ip addr show eth0
   ls /etc/netplan/
   ```

2. **Netplan設定ファイルの作成**
   ```bash
   # 設定ファイルを作成
   sudo nano /etc/netplan/01-network.yaml
   ```
   
   > **nanoエディタの使い方**:
   > - 文字入力: そのまま入力
   > - 保存: Ctrl + O → Enter
   > - 終了: Ctrl + X

3. **以下の内容をコピー＆ペースト**
   ```yaml
   network:
     version: 2
     ethernets:
       eth0:
         dhcp4: no
         addresses:
           - 192.168.234.2/24
         routes:
           - to: default
             via: 192.168.234.1
         nameservers:
           addresses:
             - 8.8.8.8
             - 8.8.4.4
   ```

4. **設定を適用**
   ```bash
   # 設定を適用
   sudo netplan apply
   
   # 確認
   ip addr show eth0
   ```
   
   ※この時点でSSH接続が切れる場合があります。その場合は新しいIP（192.168.234.2）で再接続してください。

### 4.4 基本的なシステム設定

#### ステップ1: システムの更新

```bash
# パッケージリストの更新
sudo apt update

# インストール済みパッケージの更新（5-10分かかります）
sudo apt upgrade -y
```

> **コマンドの意味**:
> - `sudo`: 管理者権限で実行
> - `apt`: パッケージ管理ツール
> - `update`: パッケージリストを最新に
> - `upgrade`: パッケージを更新
> - `-y`: すべての質問に自動でYes

#### ステップ2: 必要なソフトウェアのインストール

```bash
# 基本ツールのインストール
sudo apt install -y \
  curl \
  wget \
  git \
  vim \
  htop \
  net-tools \
  build-essential
```

> **インストールされるツール**:
> - `curl`, `wget`: ファイルダウンロード用
> - `git`: バージョン管理
> - `vim`: テキストエディタ
> - `htop`: システムモニター
> - `net-tools`: ネットワークツール
> - `build-essential`: コンパイル用ツール

#### ステップ3: Dockerのインストール

```bash
# Dockerインストールスクリプトの実行
curl -fsSL https://get.docker.com | sudo bash

# lacisadminユーザーをdockerグループに追加
sudo usermod -aG docker lacisadmin

# 一旦ログアウトして再ログイン（設定を反映）
exit
```

管理PCから再度SSH接続：
```bash
ssh lacisadmin@192.168.234.2
```

Dockerの動作確認：
```bash
# Dockerが正常に動作するか確認
docker --version
docker run hello-world
```

### 4.5 セキュリティ設定

#### ファイアウォール（UFW）の設定

```bash
# UFWのインストール
sudo apt install -y ufw

# 基本ルールの設定（VLAN1からのアクセスを許可）

# まずデフォルトルールを設定
sudo ufw default deny incoming
sudo ufw default allow outgoing

# VLAN1からのSSHアクセスを許可
sudo ufw allow from 192.168.3.0/24 to any port 22 comment 'SSH from VLAN1'

# VLAN1からの管理UIアクセスを許可  
sudo ufw allow from 192.168.3.0/24 to any port 8443 comment 'Admin UI from VLAN1'

# VLAN1からのFTPアクセスを許可
sudo ufw allow from 192.168.3.0/24 to any port 21 comment 'FTP from VLAN1'
sudo ufw allow from 192.168.3.0/24 to any port 30000:30100 comment 'FTP Passive from VLAN1'

# VLAN1全体からのWebアクセスを許可（既存設定）
sudo ufw allow from 192.168.3.0/24 to any port 80 comment 'HTTP from VLAN1'
sudo ufw allow from 192.168.3.0/24 to any port 443 comment 'HTTPS from VLAN1'

# ファイアウォールを有効化（SSH接続が切れないよう注意）
sudo ufw --force enable

# 設定の確認
sudo ufw status verbose
```

### 4.6 LPGソフトウェアの準備

#### ディレクトリの作成

```bash
# LPG用のディレクトリを作成
sudo mkdir -p /opt/lpg
sudo chown lacisadmin:lacisadmin /opt/lpg

# 設定用ディレクトリを作成
sudo mkdir -p /etc/lpg/certs
sudo mkdir -p /var/log/lpg
sudo chown -R lacisadmin:lacisadmin /etc/lpg /var/log/lpg

# FTP用ディレクトリを作成
sudo mkdir -p /var/ftp/lpg/upload
sudo mkdir -p /var/ftp/lpg/backup  
sudo mkdir -p /var/ftp/lpg/deploy
sudo chown -R lacisadmin:lacisadmin /var/ftp/lpg
```

#### 初期設定ファイルの作成

```bash
# 設定ファイルを作成
sudo nano /etc/lpg/config.json
```

以下の内容をコピー＆ペースト：
```json
{
  "hostdomains": {
    "lacisstack.ath.cx": "192.168.234.0/24"
  },
  "hostingdevice": {
    "lacisstack.ath.cx": {
      "": {
        "deviceip": "",
        "port": [],
        "sitename": "root",
        "ips": ["192.168.3.0/24"]
      },
      "/board": {
        "deviceip": "192.168.234.10",
        "port": [8080],
        "sitename": "whiteboard",
        "ips": ["192.168.3.0/24"]
      },
      "/board/ws": {
        "deviceip": "192.168.234.10",
        "port": [8081],
        "sitename": "whiteboard-ws",
        "ips": ["192.168.3.0/24"]
      },
      "/api": {
        "deviceip": "192.168.234.10",
        "port": [3000],
        "sitename": "api-server",
        "ips": ["any"]
      }
    },
    "test.lacisstack.ath.cx": {
      "": {
        "deviceip": "192.168.234.12",
        "port": [80],
        "sitename": "test-site",
        "ips": ["192.168.3.0/24"]
      }
    }
  },
  "adminuser": {
    "lacisadmin": "$argon2id$v=19$m=65536,t=3,p=4$DKlNqKTsVMCvzPEJmVmJdw$wXTKzCplGGMWYyL+vrPgTkxLPvUkW1b5gDQXUkUgkKs"
  },
  "endpoint": {
    "logserver": ""
  },
  "options": {
    "websocket_timeout": 600,
    "log_retention_days": 30
  }
}
```

保存（Ctrl+O → Enter）して終了（Ctrl+X）

### 4.7 動作確認

この時点で、基本的なセットアップは完了です。以下を確認してください：

1. **ネットワーク接続**
   ```bash
   ping -c 4 8.8.8.8
   ping -c 4 192.168.234.1
   ```

2. **ディレクトリ構造**
   ```bash
   ls -la /opt/lpg/
   ls -la /etc/lpg/
   ls -la /var/log/lpg/
   ```

3. **システム状態**
   ```bash
   # システム情報
   free -h  # メモリ使用状況
   df -h    # ディスク使用状況
   htop     # CPUとメモリの詳細（qで終了）
   ```

---

## 5. FTP経由でのデプロイメント

> **次のステップ**: この章では、FTP経由でLPGアプリケーションをOrange Piにアップロードする方法を説明します。

### 5.1 FTPサーバーのセットアップ

1. **FTP初期設定スクリプトの実行**
   ```bash
   # Dockerコンテナが起動している場合
   cd /opt/lpg
   make ftp-setup
   
   # または手動実行
   sudo docker exec -it lpg-api /usr/local/bin/setup-ftp.sh
   ```

2. **FTPサービスの確認**
   ```bash
   # 状態確認
   make ftp-status
   
   # ログ確認
   make ftp-logs
   
   # プロセス確認
   ps aux | grep vsftpd
   sudo netstat -tlnp | grep :21
   ```

### 5.2 FTPクライアントの設定（FileZilla）

1. **FileZillaのインストール**
   - https://filezilla-project.org/ からダウンロード
   - インストール実行

2. **サイトマネージャーの設定**
   ```
   ファイル → サイトマネージャー → 新しいサイト
   
   一般タブ:
     プロトコル: FTP - ファイル転送プロトコル
     ホスト: 192.168.234.2
     ポート: 21
     暗号化: 明示的なFTP over TLSが必要
     ログオンタイプ: 通常
     ユーザー: lacisadmin
     パスワード: lacis12345@
   
   詳細タブ:
     サーバータイプ: デフォルト
     既定のローカルディレクトリ: [LPGプロジェクトフォルダ]
     既定のリモートディレクトリ: /var/ftp/lpg/upload
   ```

3. **接続テスト**
   - [接続]ボタンをクリック
   - 証明書の警告が出たら[OK]（初回のみ）
   - 接続成功を確認

### 5.3 ファイルのアップロードと自動デプロイ

#### 設定ファイル（config.json）のデプロイ

1. **ローカルでconfig.jsonを編集**
   ```json
   {
     "hostdomains": {
       "lacisstack.ath.cx": "192.168.234.0/24"
     },
     "hostingdevice": {
       "lacisstack.ath.cx": {
         "": {
           "deviceip": "",
           "port": [],
           "sitename": "root",
           "ips": ["192.168.3.0/24"]
         },
         "/board": {
           "deviceip": "192.168.234.10",
           "port": [8080],
           "sitename": "whiteboard",
           "ips": ["192.168.3.0/24"]
         },
         "/board/ws": {
           "deviceip": "192.168.234.10",
           "port": [8081],
           "sitename": "whiteboard-ws",
           "ips": ["192.168.3.0/24"]
         },
         "/api": {
           "deviceip": "192.168.234.10",
           "port": [3000],
           "sitename": "api-server",
           "ips": ["any"]
         }
       },
       "test.lacisstack.ath.cx": {
         "": {
           "deviceip": "192.168.234.12",
           "port": [80],
           "sitename": "test-site",
           "ips": ["192.168.3.0/24"]
         }
       }
     },
     "adminuser": {
       "lacisadmin": "$argon2id$v=19$m=65536,t=3,p=4$..."
     },
     "endpoint": {
       "logserver": "https://logs.example.com/api/v1/logs"
     },
     "options": {
       "websocket_timeout": 600,
       "log_retention_days": 30,
       "enable_metrics": true,
       "enable_access_log": true
     }
   }
   ```

2. **FTPでアップロード**
   ```
   アップロード先: /var/ftp/lpg/upload/config.json
   ```

3. **自動デプロイの確認**
   ```bash
   # SSHでログ確認
   tail -f /var/log/lpg/ftp-deploy.log
   
   # 期待される出力:
   # [2025-01-12 10:00:00] 新しいファイルを検出: config.json
   # [2025-01-12 10:00:01] config.jsonをデプロイしました
   # [2025-01-12 10:00:02] lpg-apiサービスを再起動しました
   ```

#### アプリケーションバイナリのデプロイ

1. **ビルド済みバイナリの準備**
   ```bash
   # ローカルでビルド
   cd /path/to/lpg-project
   make build
   ```

2. **FTPアップロード**
   ```
   アップロードファイル:
   - dist/lpg-api → /var/ftp/lpg/upload/lpg-api
   ```

3. **デプロイ確認**
   ```bash
   # 実行権限とサービス再起動を確認
   ls -la /usr/local/bin/lpg-api
   sudo systemctl status lpg
   ```

#### Webアセットのデプロイ

1. **ビルド済みWebアセット**
   ```bash
   # ローカルでビルド
   npm run build
   ```

2. **FTPアップロード**
   ```
   アップロードディレクトリ:
   - dist/* → /var/ftp/lpg/upload/
   
   含まれるファイル:
   - index.html
   - assets/*.js
   - assets/*.css
   ```

### 5.4 FTPデプロイのベストプラクティス

1. **アップロード前の確認**
   - ファイルの整合性チェック
   - 設定ファイルのJSON検証
   - バイナリの実行可能性確認

2. **段階的デプロイ**
   ```
   1. 設定ファイルを先にデプロイ
   2. サービスが正常動作することを確認
   3. アプリケーションバイナリをデプロイ
   4. 最後にWebアセットをデプロイ
   ```

3. **バックアップの確認**
   ```bash
   # 自動バックアップの確認
   ls -la /var/ftp/lpg/backup/
   
   # 手動バックアップの実行
   make backup
   ```

---

## 6. 接続テスト環境のセットアップ

### 6.1 テスト用Orange Pi Zero 3の準備

1. **2台目のOrange Piセットアップ**
   - 3.1-3.3の手順を繰り返し
   - IPアドレス: 192.168.234.10を設定

2. **基本パッケージのインストール**
   ```bash
   sudo apt update
   sudo apt install -y python3 nginx nodejs npm
   ```

### 6.2 テスト用Webサーバーのセットアップ

#### シンプルなHTTPサーバー（Python）

1. **テストページの作成**
   ```bash
   mkdir -p ~/test-app
   cd ~/test-app
   
   cat > index.html << 'EOF'
   <!DOCTYPE html>
   <html>
   <head>
     <title>LPG Routing Test</title>
     <style>
       body { font-family: Arial, sans-serif; margin: 50px; }
       .success { color: green; font-size: 24px; }
       .info { background: #f0f0f0; padding: 20px; margin: 20px 0; }
     </style>
   </head>
   <body>
     <h1 class="success">✓ ルーティング成功！</h1>
     <div class="info">
       <h2>接続情報</h2>
       <p>サーバー: Orange Pi Zero 3 (Test)</p>
       <p>IP: 192.168.234.10</p>
       <p>ポート: 8080</p>
       <p>時刻: <span id="time"></span></p>
     </div>
     <script>
       document.getElementById('time').textContent = new Date().toLocaleString('ja-JP');
     </script>
   </body>
   </html>
   EOF
   ```

2. **サーバー起動スクリプト**
   ```bash
   cat > start-server.sh << 'EOF'
   #!/bin/bash
   echo "テストサーバーを起動します..."
   echo "URL: http://192.168.234.10:8080"
   python3 -m http.server 8080
   EOF
   
   chmod +x start-server.sh
   ```

3. **サービスとして登録**
   ```bash
   sudo cat > /etc/systemd/system/test-web.service << 'EOF'
   [Unit]
   Description=Test Web Server
   After=network.target
   
   [Service]
   Type=simple
   User=lacisadmin
   WorkingDirectory=/home/lacisadmin/test-app
   ExecStart=/usr/bin/python3 -m http.server 8080
   Restart=always
   
   [Install]
   WantedBy=multi-user.target
   EOF
   
   sudo systemctl daemon-reload
   sudo systemctl enable test-web
   sudo systemctl start test-web
   ```

#### WebSocketテストサーバー（Node.js）

1. **WebSocketサーバーの作成**
   ```bash
   mkdir -p ~/ws-test
   cd ~/ws-test
   npm init -y
   npm install ws
   ```

2. **サーバーコード**
   ```javascript
   cat > ws-server.js << 'EOF'
   const WebSocket = require('ws');
   
   const wss = new WebSocket.Server({ port: 8081 });
   console.log('WebSocket server running on port 8081');
   
   wss.on('connection', (ws) => {
     console.log('New client connected');
     
     ws.send(JSON.stringify({
       type: 'welcome',
       message: 'Connected to test WebSocket server',
       timestamp: new Date().toISOString()
     }));
     
     ws.on('message', (message) => {
       console.log('Received:', message.toString());
       ws.send(JSON.stringify({
         type: 'echo',
         data: message.toString(),
         timestamp: new Date().toISOString()
       }));
     });
     
     ws.on('close', () => {
       console.log('Client disconnected');
     });
   });
   EOF
   ```

3. **WebSocketクライアントテスト**
   ```html
   cat > ws-test.html << 'EOF'
   <!DOCTYPE html>
   <html>
   <head>
     <title>WebSocket Test</title>
   </head>
   <body>
     <h1>WebSocket接続テスト</h1>
     <div id="status">未接続</div>
     <button onclick="connect()">接続</button>
     <button onclick="disconnect()">切断</button>
     <button onclick="sendMessage()">メッセージ送信</button>
     <div id="messages"></div>
     
     <script>
       let ws = null;
       
       function connect() {
         // LPG経由での接続
         ws = new WebSocket('wss://lacisstack.ath.cx/board/ws');
         
         ws.onopen = () => {
           document.getElementById('status').textContent = '接続済み';
           log('WebSocket接続成功');
         };
         
         ws.onmessage = (event) => {
           log('受信: ' + event.data);
         };
         
         ws.onerror = (error) => {
           log('エラー: ' + error);
         };
         
         ws.onclose = () => {
           document.getElementById('status').textContent = '切断';
           log('接続が閉じられました');
         };
       }
       
       function disconnect() {
         if (ws) {
           ws.close();
         }
       }
       
       function sendMessage() {
         if (ws && ws.readyState === WebSocket.OPEN) {
           ws.send('Hello from client: ' + new Date().toLocaleString());
         }
       }
       
       function log(message) {
         const div = document.createElement('div');
         div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
         document.getElementById('messages').appendChild(div);
       }
     </script>
   </body>
   </html>
   EOF
   ```

### 6.3 LPGでのルーティング設定

1. **管理UIへのアクセス**
   ```
   URL: https://192.168.234.2:8443
   ユーザー: lacisadmin
   パスワード: [設定したパスワード]
   ```

2. **ドメインの追加**
   - Domains → Add Domain
   - Domain: lacisstack.ath.cx
   - Subnet: 192.168.234.0/24

3. **ルーティングルールの追加**
   - Devices → Add Rule
   ```yaml
   ルール1（HTTPテスト）:
     Domain: lacisstack.ath.cx
     Path: /board
     Device IP: 192.168.234.10
     Port: 8080
     Site Name: test-board
     Allowed IPs: 192.168.3.0/24
   
   ルール2（WebSocketテスト）:
     Domain: lacisstack.ath.cx
     Path: /board/ws
     Device IP: 192.168.234.10
     Port: 8081
     Site Name: test-ws
     Allowed IPs: 192.168.3.0/24
   ```

### 6.4 接続テストの実行

#### ローカルネットワークからのテスト

1. **HTTPアクセステスト**
   ```bash
   # 管理PCから実行
   # 直接アクセス（動作確認）
   curl http://192.168.234.10:8080
   
   # LPG経由（IPアドレス）
   curl -k https://192.168.234.2/board
   
   # ブラウザでアクセス
   # https://192.168.234.2/board
   ```

2. **WebSocketテスト**
   ```bash
   # wscat をインストール
   npm install -g wscat
   
   # 直接接続テスト
   wscat -c ws://192.168.234.10:8081
   
   # LPG経由
   wscat -c wss://192.168.234.2/board/ws --no-check
   ```

#### 外部ネットワークからのテスト（DDNS設定後）

1. **DDNS設定確認**
   ```bash
   # DNS解決確認
   nslookup lacisstack.ath.cx
   
   # 外部IPの確認
   curl ifconfig.me
   ```

2. **外部アクセステスト**
   ```bash
   # 別のネットワーク（モバイルテザリング等）から
   curl https://lacisstack.ath.cx/board
   ```

### 6.5 パフォーマンステスト

1. **Apache Benchでの負荷テスト**
   ```bash
   # インストール
   sudo apt install apache2-utils
   
   # 基本的な負荷テスト
   ab -n 1000 -c 10 https://192.168.234.2/board
   
   # WebSocketストレステスト
   npm install -g artillery
   
   # テストシナリオ作成
   cat > ws-load-test.yml << 'EOF'
   config:
     target: "wss://192.168.234.2"
     phases:
       - duration: 60
         arrivalRate: 10
   scenarios:
     - name: "WebSocket Test"
       engine: ws
       flow:
         - send: "Hello"
         - think: 1
         - send: "Test message"
         - think: 5
   EOF
   
   artillery run ws-load-test.yml
   ```

---

## 7. トラブルシューティング

### 7.1 ネットワーク接続の問題

#### LPGにSSH接続できない

1. **物理接続の確認**
   ```bash
   # シリアルコンソールから
   ip addr show eth0
   ping 192.168.234.1
   ```

2. **VLAN設定の確認**
   - Omada管理画面でスイッチポートのVLAN設定を確認
   - ポートがVLAN555に正しく割り当てられているか

3. **ファイアウォールの確認**
   ```bash
   sudo ufw status
   sudo iptables -L -n
   ```

#### HTTP/HTTPSアクセスできない

1. **Caddyの状態確認**
   ```bash
   docker-compose ps
   docker-compose logs caddy
   ```

2. **ポートの確認**
   ```bash
   sudo netstat -tlnp | grep -E ':(80|443)'
   ```

3. **Omada ACLの確認**
   - ACLルールの順序を確認（Deny より前に Permit があるか）
   - ログでブロックされていないか確認

### 7.2 FTPの問題

#### FTP接続エラー

1. **vsftpdの状態**
   ```bash
   ps aux | grep vsftpd
   sudo journalctl -u vsftpd
   ```

2. **パッシブモードの設定確認**
   ```bash
   # vsftpd.confの確認
   grep -E "pasv_|port_" /etc/vsftpd.conf
   ```

3. **証明書の問題**
   ```bash
   # 証明書の確認
   openssl x509 -in /etc/vsftpd/vsftpd.pem -text -noout
   ```

#### ファイルがデプロイされない

1. **デプロイ監視の確認**
   ```bash
   ps aux | grep ftp-deploy-watcher
   tail -f /var/log/lpg/ftp-deploy.log
   ```

2. **権限の確認**
   ```bash
   ls -la /var/ftp/lpg/upload/
   ls -la /etc/lpg/
   ```

### 7.3 パフォーマンスの問題

#### 応答が遅い

1. **システムリソースの確認**
   ```bash
   htop
   iostat -x 1
   ```

2. **ネットワーク遅延の確認**
   ```bash
   # MTRでネットワーク経路を確認
   mtr 192.168.234.10
   ```

3. **Caddyのメトリクス確認**
   ```bash
   curl http://localhost:2019/metrics
   ```

### 7.4 証明書の問題

#### Let's Encrypt証明書が取得できない

1. **DNS設定の確認**
   ```bash
   # 外部からDNS解決できるか
   dig lacisstack.ath.cx @8.8.8.8
   ```

2. **ポート80の疎通確認**
   ```bash
   # 外部からポート80にアクセスできるか
   curl -I http://lacisstack.ath.cx
   ```

3. **Caddyログの確認**
   ```bash
   docker-compose logs caddy | grep -i "certificate"
   ```

### 7.5 監視とメンテナンス

#### ログの確認

```bash
# すべてのログを表示
make logs-all

# 特定のログを確認
tail -f /var/log/lpg/access.log
tail -f /var/log/lpg/api.log
tail -f /var/log/lpg/caddy.log
```

#### ヘルスチェック

```bash
# システムヘルスチェック
make health-check

# 手動確認
curl -k https://localhost:8443/api/v1/health
```

#### バックアップとリストア

```bash
# 手動バックアップ
make backup

# バックアップ一覧
make backup-list

# リストア
make backup-restore
```

---

## 付録A: 設定ファイルテンプレート

### A.1 完全なconfig.jsonの例

```json
{
  "hostdomains": {
    "lacisstack.ath.cx": "192.168.234.0/24",
    "test.lacisstack.ath.cx": "192.168.234.0/24"
  },
  "hostingdevice": {
    "lacisstack.ath.cx": {
      "": {
        "deviceip": "",
        "port": [],
        "sitename": "root",
        "ips": ["192.168.3.0/24"]
      },
      "/board": {
        "deviceip": "192.168.234.10",
        "port": [8080],
        "sitename": "whiteboard",
        "ips": ["192.168.3.0/24"]
      },
      "/board/ws": {
        "deviceip": "192.168.234.10",
        "port": [8081],
        "sitename": "whiteboard-ws",
        "ips": ["192.168.3.0/24"]
      },
      "/api": {
        "deviceip": "192.168.234.10",
        "port": [3000],
        "sitename": "api-server",
        "ips": ["any"]
      }
    },
    "test.lacisstack.ath.cx": {
      "": {
        "deviceip": "192.168.234.12",
        "port": [80],
        "sitename": "test-site",
        "ips": ["192.168.3.0/24"]
      }
    }
  },
  "adminuser": {
    "lacisadmin": "$argon2id$v=19$m=65536,t=3,p=4$DKlNqKTsVMCvzPEJmVmJdw$wXTKzCplGGMWYyL+vrPgTkxLPvUkW1b5gDQXUkUgkKs"
  },
  "endpoint": {
    "logserver": "https://logs.example.com/api/v1/logs"
  },
  "options": {
    "websocket_timeout": 600,
    "log_retention_days": 30
  }
}
```

### A.2 Omada ACL設定例

```yaml
# 完全なACLルールセット

Rule Priority Order:
1. Allow VLAN1 Admin Access (Priority: 1-3)
2. Allow HTTP/HTTPS from LAN (Priority: 10)
3. Allow Specific Services (Priority: 11-20)
4. Block VLAN555 to Others (Priority: 100)
5. Block Internet to VLAN555 (Priority: 101)
6. Default Deny All (Priority: 1000)

Detailed Rules:

Rule: Allow-VLAN1-SSH
  Priority: 1
  Action: Permit
  Source: 192.168.3.0/24
  Destination: 192.168.234.2/32:22
  Protocol: TCP
  Schedule: Always
  Logging: Enable

Rule: Allow-VLAN1-Admin-UI
  Priority: 2
  Action: Permit
  Source: 192.168.3.0/24
  Destination: 192.168.234.2/32:8443
  Protocol: TCP
  Schedule: Always
  Logging: Enable

Rule: Allow-VLAN1-FTP
  Priority: 3
  Action: Permit
  Source: 192.168.3.0/24
  Destination: 192.168.234.2/32:21,30000-30100
  Protocol: TCP
  Schedule: Always
  Logging: Enable

Rule: Allow-LAN-HTTP
  Priority: 10
  Action: Permit
  Source: 192.168.3.0/24
  Destination: 192.168.234.2/32:80,443
  Protocol: TCP
  Schedule: Always
  Logging: Disable

Rule: Allow-VLAN555-Internet
  Priority: 20
  Action: Permit
  Source: 192.168.234.0/24
  Destination: !192.168.0.0/16
  Protocol: All
  Schedule: Always
  Logging: Disable

Rule: Block-VLAN555-to-VLAN1
  Priority: 100
  Action: Deny
  Source: 192.168.234.0/24
  Destination: 192.168.3.0/24
  Protocol: All
  Schedule: Always
  Logging: Enable

Rule: Block-Internet-to-VLAN555
  Priority: 101
  Action: Deny
  Source: 0.0.0.0/0
  Destination: 192.168.234.0/24
  Protocol: All
  Schedule: Always
  Logging: Enable
```

---

## 付録B: コマンドリファレンス

### B.1 LPG管理コマンド

```bash
# サービス管理
make dev                # 開発環境起動
make dev-stop          # 開発環境停止
make dev-logs          # ログ表示
make build             # ビルド実行
make clean             # クリーンアップ

# FTP管理
make ftp-setup         # FTPセットアップ
make ftp-status        # FTP状態確認
make ftp-logs          # FTPログ表示

# 監視・メンテナンス
make monitor           # 監視状態確認
make health-check      # ヘルスチェック
make backup            # バックアップ実行
make backup-list       # バックアップ一覧
make backup-restore    # リストア
make security          # セキュリティ設定

# システム情報
make system-info       # システム情報表示
make logs-all          # 全ログ表示
make version           # バージョン情報
```

### B.2 トラブルシューティングコマンド

```bash
# ネットワーク診断
ip addr show
ip route show
ping -c 4 192.168.234.1
traceroute 8.8.8.8
nslookup lacisstack.ath.cx

# サービス診断
systemctl status lpg
docker-compose ps
docker-compose logs -f
journalctl -u lpg -f

# ポート診断
netstat -tlnp
ss -tlnp
lsof -i :80
nc -zv 192.168.234.10 8080

# ファイル確認
ls -la /etc/lpg/
ls -la /var/log/lpg/
tail -f /var/log/lpg/*.log

# プロセス確認
ps aux | grep -E '(caddy|lpg|vsftpd|telegraf)'
htop
```

---

これで、LacisProxyGatewayの完全なセットアップ手順書が完成しました。この手順書に従って、実機でのデプロイメントを進めることができます。 