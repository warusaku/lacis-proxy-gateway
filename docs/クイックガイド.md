---
title: 1) システム更新
projects:
- LPG
tags:
- '#proj-lpg'
created: '2025-07-28'
updated: '2025-07-28'
author: unknown
status: draft
---
## LacisProxyGateway クイックガイド

**対象:** IT 初心者・入社まもない方（例 20 歳の新入社員）
**目標:** 「社内ネットワークに LPG（Lacis Proxy Gateway）を導入し、テストページが見える状態にする」
**作業時間の目安:** 約 2 ～ 3 時間（ダウンロードや更新を含む）

---

### 0. 全体イメージ

1. **ネットワークを準備**（Omada クラウドで VLAN を作成）
2. **LPG 用 Orange Pi に Linux を入れる**（SD カード書き込み → 電源 ON）
3. **PC から遠隔操作（SSH）できるようにする**
4. **ソフトを入れて設定ファイルを置く**
5. **テスト用 Orange Pi で “動いた！” ページを公開**
6. **ブラウザからアクセスして動作確認**

図で表すと次のようになります（★はあなたが操作する機器）

```
[管理PC★]────┐                ★SSH/FTP
               │192.168.3.x (管理LAN)
 [Omada ゲートウェイ]───[VLAN555]───[LPG★]───[テストサーバー★]
```

---

### 1. 事前準備チェックリスト

| チェック | 内容                                           |
| ---- | -------------------------------------------- |
| ☐    | Omada クラウドにログインできる（ID と PW がある）              |
| ☐    | ER605 ゲートウェイ・スイッチが Omada に登録済み               |
| ☐    | Orange Pi Zero 3 ×2 台・SD カード ×2 枚・5 V 3 A 電源 |
| ☐    | Windows/Mac の管理 PC（SSH と FTP クライアントあり）       |
| ☐    | LAN ケーブル数本                                   |

---

### 2. Omada（ネットワーク）設定 ★PC で実施

1. **VLAN555 を作る**

   * *Settings → Wired Networks → LAN → \[＋ Create]*
   * **VLAN ID**: 555 / **Gateway**: 192.168.234.1/24 / **DHCP**: 有効
2. **DHCP 予約**

   * LPG 用 MAC アドレス → IP **192.168.234.2**
   * テストサーバー用 → **192.168.234.10**
3. **スイッチポート**

   * Port1（LPG）・Port2（テストサーバー）とも **Native VLAN: lacisstack(VLAN555)**
4. **ACL（通信ルール）**

   * VLAN555 → 他 VLAN へ **遮断**
   * 管理LAN (192.168.3.0/24) → LPG の **SSH(22)／管理UI(8443)／FTP(21,30000‑30100)** を **許可**
   * 管理LAN → LPG の **HTTP/HTTPS(80,443)** を **許可**
5. **ポートフォワード（外部公開が必要なら）**

   * 80 → 192.168.234.2:80
   * 443 → 192.168.234.2:443

> **ポイント**
> エラーが出ても慌てず、\[Logs] で赤い行がないか確認しましょう。

---

### 3. Orange Pi Zero 3（LPG 用）セットアップ

| 手順 | ざっくり説明                                        |
| -- | --------------------------------------------- |
| ①  | **Armbian イメージをダウンロード**（公式サイト）                |
| ②  | **balenaEtcher** で SD カードに書き込む                |
| ③  | Orange Pi に SD を挿し、LAN→HDMI→キーボード→電源の順で接続     |
| ④  | 画面に `login:` が出たら **root / 1234** → 新パスワードを設定 |
| ⑤  | 新ユーザー `lacisadmin` を作成（パスワードはメモ）              |
| ⑥  | 画面で **MAC** と **IP** をメモ（あとで DHCP 予約に使う）      |
| ⑦  | `shutdown -h now` で電源を切り、HDMI とキーボードを外す       |

---

### 4. SSH で遠隔操作

1. Orange Pi をネットワークに戻し、電源 ON
2. **管理 PC** でコマンドプロンプト (Win) またはターミナル (Mac) を開く
3. 接続（例）

   ```bash
   ssh lacisadmin@192.168.234.2
   ```
4. 入れたら **成功メッセージ** が表示されます 👍

---

### 5. LPG ソフトと環境のインストール

> すべて SSH で実行します。

```bash
# 1) システム更新
sudo apt update && sudo apt upgrade -y

# 2) よく使うツール
sudo apt install -y curl wget git vim htop net-tools

# 3) Docker
curl -fsSL https://get.docker.com | sudo bash
sudo usermod -aG docker lacisadmin
exit   # ← 一度ログアウトして再ログイン
```

**固定 IP を設定する場合**（推奨）

```bash
sudo nano /etc/netplan/01-network.yaml
# → 以下を貼り付け保存
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: no
      addresses: [192.168.234.2/24]
      routes:
        - to: default
          via: 192.168.234.1
      nameservers:
        addresses: [8.8.8.8,8.8.4.4]

sudo netplan apply
```

---

### 6. LPG 用フォルダー＆設定ファイル

```bash
sudo mkdir -p /opt/lpg /etc/lpg /var/log/lpg
sudo chown -R lacisadmin:lacisadmin /opt/lpg /etc/lpg /var/log/lpg
nano /etc/lpg/config.json   # → 付録のサンプルを貼る
```

---

### 7. FTP でアプリを送り込む

1. **FileZilla** を開き、

   * ホスト: 192.168.234.2 / ユーザー: lacisadmin / パスワード入力 / 暗号化: TLS
2. リモート側の `/var/ftp/lpg/upload/` に **config.json** や **アプリ一式** をドラッグ＆ドロップ
3. 自動でデプロイされ、サービスが再起動します

   * ログ確認: `tail -f /var/log/lpg/ftp-deploy.log`

---

### 8. テスト用 Orange Pi（Web サーバー）を作成

1. **手順 3** をもう一度実施し、固定 IP **192.168.234.10** をセット
2. SSH で入り、シンプルな HTTP サーバーを起動

   ```bash
   sudo apt install -y python3
   mkdir ~/test && cd $_
   echo 'Hello LPG!' > index.html
   python3 -m http.server 8080 &
   ```
3. 動作確認

   ```bash
   curl http://192.168.234.10:8080
   ```

---

### 9. LPG ルール追加と最終テスト

1. **ブラウザ** で `https://192.168.234.2:8443` → 管理 UI にログイン
2. **Routing Rule** を追加

   * Domain: `lacisstack.ath.cx`
   * Path: `/board`
   * Device IP: `192.168.234.10` / Port: `8080`
3. **管理 PC** からアクセス

   ```bash
   # LPG 経由
   curl -k https://192.168.234.2/board
   # → “Hello LPG!” が返れば成功
   ```

> **外部からも見たいとき**
>
> * DDNS を `lacisstack.ath.cx` に向ける
> * ゲートウェイで 80/443 を LPG にポートフォワード
> * スマホ回線など別ネットワークからアクセスして確認

---

### 10. 困ったときは…

| 症状          | 確認ポイント                                                             |
| ----------- | ------------------------------------------------------------------ |
| SSH できない    | ① ケーブル抜けてない？ ② VLAN555 にいる？ ③ Omada ACL で 22 ポート許可済み？              |
| Web が表示されない | ① テストサーバー直で表示できる？<br>② LPG ルールの Path / Port 合ってる？                  |
| FTP で転送できない | ① FileZilla の暗号化設定は “明示的な TLS”？<br>② UFW で 21 / 30000‑30100 が開放済み？ |

---

## 付録：よく使うコマンド早見表

```bash
# LPG 本体のログを見る
tail -f /var/log/lpg/*.log

# Docker コンテナ一覧
docker ps

# ネットワーク状態
ip addr show
ping 192.168.234.1

# サーバー再起動
sudo reboot
```

---

### おわりに

* **まずは VLAN と IP** が正しく通るか確認するのが成功への近道です。
* 手順を飛ばすとトラブルの元。わからなくなったら **必ず先輩に相談** してください。
* 詳細設定や高度なチューニングは、元の「詳細版手順書」を参照すれば OK です。

これでクイックガイドは完了です。お疲れさまでした！
