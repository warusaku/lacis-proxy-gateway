# LPG セットアップログ - 2025年7月31日

## デバイス情報
- **機器**: Orange Pi Zero 3
- **IP**: 192.168.234.2
- **OS**: Orange Pi 1.0.2 Jammy (Linux 6.1.31-sun50iw9)
- **用途**: Lacis Proxy Gateway (リバースプロキシ)

## セットアップ手順

### 1. 初期アクセス
```bash
ssh root@192.168.234.2
# パスワード: orangepi
```

### 2. ユーザー作成
```bash
useradd -m -s /bin/bash lacissystem
echo 'lacissystem:lacis12345@' | chpasswd
usermod -aG sudo lacissystem
```

### 3. ディレクトリ構成
```bash
mkdir -p /opt/lpg /etc/lpg /var/log/lpg /var/ftp/lpg
chown -R lacissystem:lacissystem /opt/lpg /etc/lpg /var/log/lpg /var/ftp/lpg
```

### 4. システムアップデート
```bash
dpkg --configure -a  # 中断されたパッケージ設定を修復
apt-get update
apt-get install -y python3
```

### 5. プロキシサーバー実装
Python3ベースの簡易プロキシサーバーを実装：

```python
#!/usr/bin/env python3
# /home/lacissystem/lpg-proxy.py
from http.server import HTTPServer, BaseHTTPRequestHandler
import urllib.request
import urllib.error
import json

class LPGProxyHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/health':
            # ヘルスチェックエンドポイント
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            status = {
                'status': 'healthy',
                'service': 'LPG Proxy Gateway',
                'version': '1.0',
                'routes': [
                    '/lacisstack/boards -> 192.168.234.10:8080'
                ]
            }
            self.wfile.write(json.dumps(status).encode())
        elif self.path.startswith('/lacisstack/boards'):
            # LacisDrawBoardsへのプロキシ
            target_path = self.path.replace('/lacisstack/boards', '')
            if not target_path:
                target_path = '/'
            target_url = f'http://192.168.234.10:8080{target_path}'
            
            try:
                # リクエスト転送
                req = urllib.request.Request(target_url)
                for header in self.headers:
                    if header.lower() not in ['host']:
                        req.add_header(header, self.headers[header])
                req.add_header('X-Forwarded-For', self.client_address[0])
                req.add_header('X-Forwarded-Host', self.headers.get('Host', ''))
                req.add_header('X-Forwarded-Prefix', '/lacisstack/boards')
                
                with urllib.request.urlopen(req, timeout=5) as response:
                    self.send_response(response.getcode())
                    for header, value in response.headers.items():
                        self.send_header(header, value)
                    self.end_headers()
                    self.wfile.write(response.read())
            except (urllib.error.URLError, ConnectionRefusedError) as e:
                # ターゲット不在時のエラーハンドリング
                self.send_response(503)
                self.send_header('Content-type', 'text/html')
                self.end_headers()
                error_html = f'''
<html>
<head><title>LPG Proxy - Service Unavailable</title></head>
<body>
<h1>LPG Proxy Gateway</h1>
<h2>Target Service Unavailable</h2>
<p>Unable to connect to: {target_url}</p>
<p>Error: {str(e)}</p>
<hr>
<p>Route: /lacisstack/boards → 192.168.234.10:8080</p>
<p>This demonstrates that LPG is correctly routing the request.</p>
</body>
</html>
'''
                self.wfile.write(error_html.encode())
        else:
            # デフォルトレスポンス
            self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write(b'<h1>LPG Proxy Gateway</h1><p>Ready</p>')

if __name__ == '__main__':
    server = HTTPServer(('0.0.0.0', 80), LPGProxyHandler)
    print('LPG Proxy listening on port 80')
    server.serve_forever()
```

### 6. サービス起動
```bash
chmod +x /home/lacissystem/lpg-proxy.py
nohup python3 /home/lacissystem/lpg-proxy.py > /var/log/lpg-proxy.log 2>&1 &
```

### 7. 動作確認
```bash
# プロセス確認
ps aux | grep lpg-proxy
# root        7280 12.5  0.4  27004 17544 pts/0    S    16:22   0:00 python3 /home/lacissystem/lpg-proxy.py

# ポート確認
netstat -tlnp | grep :80
# tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      7280/python3

# ヘルスチェック
curl -s http://localhost/health | python3 -m json.tool
# {
#     "status": "healthy",
#     "service": "LPG Proxy Gateway",
#     "version": "1.0",
#     "routes": [
#         "/lacisstack/boards -> 192.168.234.10:8080"
#     ]
# }
```

## 仕様変更点

### 1. DDNS設定の変更
- **変更前**: 新規DDNS `lacisstack.ath.cx` を使用予定
- **変更後**: 既存DDNS `akb001yebraxfqsm9y.dyndns-web.com` を使用
- **理由**: Omadaの制限により1つのWANポートに1つのDDNSしか設定不可

### 2. ルーティング方式の変更
- **変更前**: サブドメインベース（boards.lacisstack.ath.cx）
- **変更後**: パスベース（akb001yebraxfqsm9y.dyndns-web.com/lacisstack/boards）
- **設定**: `/lacisstack/boards/*` → `192.168.234.10:8080/*`

### 3. 実装方式の変更
- **当初予定**: Caddy Webサーバー
- **現在**: Python3 HTTPServerによる簡易実装
- **理由**: apt/dpkgの設定問題により、迅速な動作確認を優先

## 残課題
1. Caddyへの移行（本番環境）
2. HTTPS/TLS設定
3. FTPデプロイ機能の実装
4. systemdサービス化
5. ログローテーション設定
6. セキュリティ強化（ファイアウォール設定等）

## トラブルシューティング記録
1. **SSH認証問題**: lacissystemユーザーが存在しなかった → rootでログイン後作成
2. **apt lock問題**: dpkg設定が中断されていた → `dpkg --configure -a`で修復
3. **Caddy インストール失敗**: パッケージマネージャの問題 → Python3で代替実装

## WebUI実装（2025年7月31日追記）

### 実装内容
Python Flask ベースの管理UIを実装：
- **URL**: http://192.168.234.2:8443
- **認証**: admin / lpgadmin123
- **技術スタック**: Flask + Jinja2 + Primer CSS

### 主な機能
1. ドメイン管理
2. ルーティングルール設定
3. ログビューアー
4. ネットワーク状態監視
5. 設定管理（JSON編集）

### サービス構成
```
/etc/systemd/system/lpg.service
- プロキシ（ポート80）とWebUI（ポート8443）を統合管理
- systemctl status lpg.service で状態確認可能
```

## 次のステップ
1. Orange Pi 5 Plus (192.168.234.10) の設定
2. LacisDrawBoardsアプリケーションのデプロイ
3. 本番環境への移行準備