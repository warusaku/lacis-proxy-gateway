{% extends "base_dark.html" %}

{% block title %}設定 - LacisProxyGateway{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4"><i class="bi bi-gear"></i> 設定</h1>

    <div class="row">
        <!-- ユーザー管理 -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h5><i class="bi bi-people"></i> ユーザー管理</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus"></i> ユーザー追加
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ユーザー名</th>
                                    <th>権限</th>
                                    <th>最終ログイン</th>
                                    <th>アクション</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="bi bi-shield-lock"></i> admin</td>
                                    <td><span class="badge bg-danger">マスター</span></td>
                                    <td>{{ session.get('last_login', 'N/A') }}</td>
                                    <td><span class="text-muted">削除不可</span></td>
                                </tr>
                                {% if config.get('adminuser') %}
                                    {% for user, user_data in config.adminuser.items() %}
                                    {% if user != 'admin' %}
                                    <tr>
                                        <td>{{ user }}</td>
                                        <td><span class="badge bg-info">管理者</span></td>
                                        <td>{{ user_data.get('last_login', 'N/A') if user_data is mapping else 'N/A' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lacis設定 -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-diagram-2"></i> Lacis設定</h5>
                </div>
                <div class="card-body">
                    <form id="lacisSettingsForm">
                        <div class="mb-3">
                            <label class="form-label">Lacisエンドポイント</label>
                            <input type="url" class="form-control" id="lacisEndpoint" 
                                   value="{{ config.endpoint.logserver or 'https://lacis.example.com' }}"
                                   placeholder="https://lacis.example.com">
                            <small class="form-text text-muted">Lacisサーバーのエンドポイントを設定します</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ハートビートサイクル（秒）</label>
                            <input type="number" class="form-control" id="heartbeatCycle" 
                                   value="{{ config.options.heartbeat_interval or 60 }}" min="10" max="3600">
                            <small class="form-text text-muted">ハートビート送信間隔（10-3600秒）</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lacis ID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="lacisId" 
                                       value="{{ config.options.lacis_id or '' }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="generateLacisId()">
                                    <i class="bi bi-arrow-clockwise"></i> 生成
                                </button>
                            </div>
                            <small class="form-text text-muted">デバイス識別用の一意なID</small>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="saveLacisSettings()">
                            <i class="bi bi-save"></i> Lacis設定を保存
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- システム設定 -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="bi bi-sliders"></i> システム設定</h5>
                </div>
                <div class="card-body">
                    <form id="systemSettingsForm">
                        <div class="mb-3">
                            <label class="form-label">プロキシポート</label>
                            <input type="number" class="form-control" id="proxyPort" 
                                   value="{{ config.options.proxy_port or 8080 }}" min="1024" max="65535">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">管理UIポート</label>
                            <input type="number" class="form-control" id="adminPort" 
                                   value="{{ config.options.admin_port or 8443 }}" min="1024" max="65535">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ログレベル</label>
                            <select class="form-select" id="logLevel">
                                <option value="DEBUG" {% if config.options.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="INFO" {% if config.options.log_level == 'INFO' or not config.options.log_level %}selected{% endif %}>INFO</option>
                                <option value="WARNING" {% if config.options.log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                                <option value="ERROR" {% if config.options.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-secondary" onclick="saveSystemSettings()">
                            <i class="bi bi-save"></i> システム設定を保存
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 設定エクスポート/インポート -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-file-earmark-arrow-down"></i> 設定の管理</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>設定のエクスポート</h6>
                            <p>現在の設定をJSONファイルとしてダウンロードします。</p>
                            <button class="btn btn-info" onclick="exportConfig()">
                                <i class="bi bi-download"></i> エクスポート
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>設定のインポート</h6>
                            <p>JSONファイルから設定を読み込みます。</p>
                            <input type="file" id="configFile" accept=".json" class="form-control mb-2">
                            <button class="btn btn-warning" onclick="importConfig()">
                                <i class="bi bi-upload"></i> インポート
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ユーザー追加モーダル -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ユーザー追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">ユーザー名</label>
                        <input type="text" class="form-control" name="username" required 
                               pattern="[a-zA-Z0-9_-]{3,20}" 
                               title="英数字、ハイフン、アンダースコアのみ（3-20文字）">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">パスワード</label>
                        <input type="password" class="form-control" name="password" required 
                               minlength="8">
                        <small class="form-text text-muted">8文字以上</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">パスワード（確認）</label>
                        <input type="password" class="form-control" name="password_confirm" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="addUser()">追加</button>
            </div>
        </div>
    </div>
</div>

<script>
function generateLacisId() {
    const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
    document.getElementById('lacisId').value = 'lpg-' + uuid;
}

function addUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    
    if (formData.get('password') !== formData.get('password_confirm')) {
        alert('パスワードが一致しません');
        return;
    }
    
    const data = {
        username: formData.get('username'),
        password: formData.get('password')
    };
    
    fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            location.reload();
        } else {
            alert('エラー: ' + result.message);
        }
    });
}

function deleteUser(username) {
    if (confirm(`ユーザー "${username}" を削除しますか？`)) {
        fetch('/api/users/' + username, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                location.reload();
            } else {
                alert('エラー: ' + result.message);
            }
        });
    }
}

function saveLacisSettings() {
    const settings = {
        endpoint: { logserver: document.getElementById('lacisEndpoint').value },
        options: {
            heartbeat_interval: parseInt(document.getElementById('heartbeatCycle').value),
            lacis_id: document.getElementById('lacisId').value
        }
    };
    
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            config.endpoint.logserver = settings.endpoint.logserver;
            config.options = {...config.options, ...settings.options};
            
            return fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                alert('Lacis設定を保存しました');
            } else {
                alert('エラー: ' + result.message);
            }
        });
}

function saveSystemSettings() {
    const settings = {
        options: {
            proxy_port: parseInt(document.getElementById('proxyPort').value),
            admin_port: parseInt(document.getElementById('adminPort').value),
            log_level: document.getElementById('logLevel').value
        }
    };
    
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            config.options = {...config.options, ...settings.options};
            
            return fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                alert('システム設定を保存しました');
            } else {
                alert('エラー: ' + result.message);
            }
        });
}

function exportConfig() {
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lpg-config-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        });
}

function importConfig() {
    const fileInput = document.getElementById('configFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('ファイルを選択してください');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const config = JSON.parse(e.target.result);
            
            if (confirm('現在の設定を上書きしますか？')) {
                fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        alert('設定をインポートしました');
                        location.reload();
                    } else {
                        alert('エラー: ' + result.message);
                    }
                });
            }
        } catch (err) {
            alert('無効なJSONファイルです: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// Lacis IDが未設定の場合は自動生成
if (!document.getElementById('lacisId').value) {
    generateLacisId();
}
</script>
{% endblock %}